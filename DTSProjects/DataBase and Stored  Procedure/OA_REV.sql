-----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK ESISTING DATA OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_Existing_OA' AND TYPE ='P')
DROP PROCEDURE  Sp_Check_Existing_OA
GO
CREATE PROCEDURE Sp_Check_Existing_OA
@PO_REF_NO VARCHAR(25),@SHIP_TO_ID VARCHAR(25)
AS
BEGIN
   IF EXISTS(SELECT SHIP_TO_ID FROM OA_SHIP_TO WHERE SHIP_TO_ID = @SHIP_TO_ID
            AND OA_ID = (SELECT TOP 1 OA_ID FROM ORDR_ORDER_ACCEPTANCE WHERE PO_REF_NO = @PO_REF_NO))

   BEGIN
        RETURN(1)	
   END 
END
RETURN(0)
GO
-----------------------------------------------------------------------------------------
--PROCEDUR UNTUK MENGEEK REFERENSI OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_REFERENCED_OA' AND TYPE = 'P')
DROP PROCEDURE Sp_Check_REFERENCED_OA
GO
CREATE PROCEDURE Sp_Check_REFERENCED_OA
@OA_ID VARCHAR(32)
AS
BEGIN
   IF (SELECT COUNT(OA_ID) FROM ORDR_OA_BRANDPACK WHERE OA_ID = @OA_ID) > 0
	RETURN(1)
   ELSE IF (SELECT COUNT(OA_ID) FROM ORDR_SALES_BOOK WHERE OA_ID = @OA_ID) > 0
	RETURN(2)
   END
RETURN(0)
GO
--------------------------------------------------------------------------------
-----------------PROCEDURE UNTUK MENGAMBIL ROW PADA SAAT OA_ID MAU DIEDIT I FORM ACCEPTANCE
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Create_View_Territory_By_OA_ID'
	AND TYPE = 'P')
DROP PROCEDURE Usp_Create_View_Territory_By_OA_ID
GO
CREATE PROCEDURE Usp_Create_View_Territory_By_OA_ID
@OA_ID VARCHAR(32)
AS
SELECT TERRITORY_ID FROM DIST_SHIP_TO WHERE DIST_SHIP_TO_ID IN(SELECT DIST_SHIP_TO_ID
FROM OA_SHIP_TO WHERE OA_ID = @OA_ID)
GO

--------------------------------------------------------------------------------------------

--PROCEDURE UNTUK MENGINSERT DATA OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Insert_OA' AND TYPE ='P')
DROP PROCEDURE Sp_Insert_OA
GO
CREATE PROCEDURE Sp_Insert_OA
@OA_ID VARCHAR(32),
@OA_DATE DATETIME,
@PO_REF_NO VARCHAR(25),
@CREATE_BY VARCHAR(30),
@RUN_NUMBER VARCHAR(10)
AS
INSERT INTO ORDR_ORDER_ACCEPTANCE(OA_ID,OA_DATE,PO_REF_NO,RUN_NUMBER,CREATE_BY,CREATE_DATE)
VALUES(@OA_ID,@OA_DATE,@PO_REF_NO,@RUN_NUMBER,@CREATE_BY,GETDATE())
GO

----------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGUPDATE DATA OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Update_OA' AND TYPE = 'P')
DROP PROCEDURE Sp_Update_OA
GO
CREATE PROCEDURE Sp_Update_OA
@OA_ID VARCHAR(32),
@OA_DATE DATETIME,
@PO_REF_NO VARCHAR(25),
@MODIFY_BY VARCHAR(30),
@RUN_NUMBER VARCHAR(10)
AS
UPDATE ORDR_ORDER_ACCEPTANCE SET OA_DATE = @OA_DATE,PO_REF_NO = @PO_REF_NO,
MODIFY_BY = @MODIFY_BY,MODIFY_DATE = GETDATE()
WHERE OA_ID = @OA_ID
GO
-----------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENDELETE DATA OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Delete_OA' AND TYPE = 'P')
DROP PROCEDURE Sp_Delete_OA
GO
CREATE PROCEDURE Sp_Delete_OA
@OA_ID VARCHAR(32)
AS

DELETE FROM OA_SHIP_TO WHERE OA_ID = @OA_ID
IF (@@ROWCOUNT > 0)
   BEGIN
	DELETE FROM ORDR_ORDER_ACCEPTANCE WHERE OA_ID = @OA_ID
	IF (@@ERROR <> 0)
	    RAISERROR('Can not delete OA Header',16,1)
	IF (@@ROWCOUNT > 0)
	    BEGIN
		UPDATE OACOUNT SET OA_COUNT = CAST((SELECT OA_COUNT FROM OACOUNT) AS INT) -1
	    
	    END
   END

GO
------------------------------------------------------------------------------------
------PROCEDURE UNTUK MENGINSERT OA_SHIP_TO BARU----------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Insert_OA_Ship_To' AND TYPE = 'P')
DROP PROCEDURE Usp_Insert_OA_Ship_To
GO
CREATE PROCEDURE Usp_Insert_OA_Ship_To
@OA_SHIP_TO_ID VARCHAR(57),
@OA_ID VARCHAR(32),
@SHIP_TO_ID VARCHAR(25),
@CREATE_BY VARCHAR(30)
AS
INSERT INTO OA_SHIP_TO(OA_SHIP_TO_ID,OA_ID,SHIP_TO_ID,CREATE_BY,CREATE_DATE)
VALUES(@OA_SHIP_TO_ID,@OA_ID,@SHIP_TO_ID,@CREATE_BY,GETDATE())
GO
-----------------------------------------------------------------------------
-------------------------PROCEDURE UNTUK MENDELETE OA_SHIP_TO--------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME  = 'Usp_Delete_OA_Ship_To' AND TYPE = 'P')
DROP PROCEDURE Usp_Delete_OA_Ship_To
GO
CREATE PROCEDURE Usp_Delete_OA_Ship_To
@OA_ID VARCHAR(32)
AS
DELETE FROM OA_SHIP_TO WHERE OA_ID = @OA_ID
GO

--PROCEDURE UNTUK  MENGAMBIL DATA PO_REF_NO UNTUK DI BINDINGKAN DI MULTICOLUMN COMBO
--DI FORM OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetView_DISTRIBUTOR_PO' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_DISTRIBUTOR_PO
GO
CREATE PROCEDURE Sp_GetView_DISTRIBUTOR_PO
AS
SET NOCOUNT ON;
SELECT TOP 100 PO.PO_REF_NO,PO.DISTRIBUTOR_ID,DR.DISTRIBUTOR_NAME,PO.PO_REF_DATE 
FROM ORDR_PURCHASE_ORDER PO INNER JOIN DIST_DISTRIBUTOR DR ON PO.DISTRIBUTOR_ID = DR.DISTRIBUTOR_ID
WHERE EXISTS(SELECT PO_REF_NO FROM ORDR_PO_BRANDPACK WHERE PO_REF_NO = PO.PO_REF_NO)
ORDER BY PO.PO_REF_DATE DESC;
GO
--exec Sp_GetView_DISTRIBUTOR_PO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Create_View_TM_by_OA_ID' AND TYPE = 'P')
DROP PROCEDURE Usp_Create_View_TM_by_OA_ID
GO
CREATE PROCEDURE Usp_Create_View_TM_by_OA_ID
@OA_ID VARCHAR(32)
AS
SELECT ST.SHIP_TO_ID,TER.TERRITORY_AREA,TM.MANAGER
FROM TERRITORY TER INNER JOIN SHIP_TO ST ON TER.TERRITORY_ID = ST.TERRITORY_ID
INNER JOIN TERRITORY_MANAGER TM ON ST.TM_ID = TM.TM_ID
WHERE ST.SHIP_TO_ID IN(SELECT SHIP_TO_ID FROM OA_SHIP_TO WHERE OA_ID = @OA_ID)
GO

--SELECT * FROM ORDR_PURCHASE_ORDER WHERE CREATE_DATE >= GETDATE()
-------------------------------------------------------------------------------------

--PROCEDUR UNTUK MEMVIEW OA_BY DISTRIBUTOR_ID OA_BELUM ADA REFERENSI TABLE ANAK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetView_UNREFERENCED_OA_BY_DISTRIBUTOR_ID' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_UNREFERENCED_OA_BY_DISTRIBUTOR_ID
GO
CREATE PROCEDURE Sp_GetView_UNREFERENCED_OA_BY_DISTRIBUTOR_ID
@DISTRIBUTOR_ID VARCHAR(10)
AS
SELECT DISTINCT ORDR_ORDER_ACCEPTANCE.OA_ID FROM ORDR_ORDER_ACCEPTANCE,ORDR_PURCHASE_ORDER,DISTRIBUTOR_AGREEMENT,AGREE_AGREEMENT
WHERE ORDR_ORDER_ACCEPTANCE.PO_REF_NO = ORDR_PURCHASE_ORDER.PO_REF_NO 
AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID
= DISTRIBUTOR_AGREEMENT.DISTRIBUTOR_ID AND DISTRIBUTOR_AGREEMENT.AGREEMENT_NO = AGREE_AGREEMENT.AGREEMENT_NO
AND AGREE_AGREEMENT.END_DATE >= GETDATE()
AND ORDR_ORDER_ACCEPTANCE.OA_ID NOT IN(SELECT DISTINCT OA_ID FROM ORDR_OA_BRANDPACK)
GO

--EXEC Sp_GetView_UNREFERENCED_OA_BY_DISTRIBUTOR_ID
--@DISTRIBUTOR_ID = 'ANE002IDR'
-------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENYELEKSI DATA OA_REF_NO UNTUK ORDER_ACCEPTANCE
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetViewOA' AND TYPE = 'P')
DROP PROCEDURE 	Sp_GetViewOA
GO
CREATE PROCEDURE Sp_GetViewOA
AS
SET NOCOUNT ON;
SELECT TOP 100 OOA.OA_ID AS OA_REF_NO,OOA.OA_DATE,OOP.DISTRIBUTOR_ID ,OOP.PO_REF_DATE,DR.DISTRIBUTOR_NAME AS PO_FROM,
OOP.PO_REF_NO--,DST.DISTRIBUTOR_ID AS SHIP_TO_DISTRIBUTOR,
FROM ORDR_ORDER_ACCEPTANCE OOA INNER JOIN ORDR_PURCHASE_ORDER OOP ON OOP.PO_REF_NO = OOA.PO_REF_NO
INNER JOIN DIST_DISTRIBUTOR DR ON OOP.DISTRIBUTOR_ID = DR.DISTRIBUTOR_ID
WHERE YEAR(OOA.OA_DATE) >= YEAR(GETDATE()) -1 --ORDER BY RIGHT(OOA.OA_ID,4) DESC
GO

--SELECT TOP 100 OOA.OA_ID AS OA_REF_NO,OOA.OA_DATE,OOP.DISTRIBUTOR_ID ,OOP.PO_REF_DATE,DR.DISTRIBUTOR_NAME AS PO_FROM,
--OOP.PO_REF_NO--,DST.DISTRIBUTOR_ID AS SHIP_TO_DISTRIBUTOR,
--FROM ORDR_ORDER_ACCEPTANCE OOA INNER JOIN ORDR_PURCHASE_ORDER OOP ON OOP.PO_REF_NO = OOA.PO_REF_NO
--INNER JOIN DIST_DISTRIBUTOR DR ON OOP.DISTRIBUTOR_ID = DR.DISTRIBUTOR_ID
-- ORDER BY OOA.IDAPP DESC

-------------------------------------------------------------------------------------
---------------DESCRISI OA --DIPAKAI BILA OA_REF_NO DI PILIH DI MCBOAREFNO FORM OA_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Get_OA_Description' AND TYPE = 'P')
DROP PROCEDURE Usp_Get_OA_Description
GO
--CREATE PROCEDURE Usp_Get_OA_Description
--@OA_REF_NO VARCHAR(30)
--AS
--SELECT TER.TERRITORY_AREA FROM TERRITORY TER INNER JOIN DIST_SHIP_TO DST
--ON TER.TERRITORY_ID = DST.TERRITORY_ID INNER JOIN OA_SHIP_TO OST
--ON OST.DIST_SHIP_TO_ID = DST.DIST_SHIP_TO_ID WHERE OST.OA_ID = @OA_REF_NO
-- GO

--PROCEDURE UNTUK MEMFILTER OA
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Search_OARef' AND TYPE = 'P')
DROP PROCEDURE Usp_Search_OARef
GO
CREATE PROCEDURE Usp_Search_OARef
@SearchOARef VARCHAR(75)
AS
SET NOCOUNT ON;
SELECT TOP 100 OOA.OA_ID AS OA_REF_NO,OOA.OA_DATE,OOP.DISTRIBUTOR_ID ,OOP.PO_REF_DATE,DR.DISTRIBUTOR_NAME AS PO_FROM,
OOP.PO_REF_NO
FROM ORDR_ORDER_ACCEPTANCE OOA INNER JOIN ORDR_PURCHASE_ORDER OOP ON OOP.PO_REF_NO = OOA.PO_REF_NO
INNER JOIN DIST_DISTRIBUTOR DR ON OOP.DISTRIBUTOR_ID = DR.DISTRIBUTOR_ID
AND OOA.OA_ID LIKE '%' + @SearchOARef + '%'-- ORDER BY RIGHT(OOA.OA_ID,4) DESC;
GO


-----------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENAMPILKAN DISTRIBUTOR PO BERDASARKAN DATA OA_REF
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Select_Distributor_PO' AND TYPE = 'P')
DROP PROCEDURE Sp_Select_Distributor_PO
GO
CREATE PROCEDURE Sp_Select_Distributor_PO
@OA_ID varchar(32)
AS
SELECT DIST_DISTRIBUTOR.DISTRIBUTOR_ID, DIST_DISTRIBUTOR.DISTRIBUTOR_NAME FROM DIST_DISTRIBUTOR,ORDR_ORDER_ACCEPTANCE,ORDR_PURCHASE_ORDER
WHERE ORDR_ORDER_ACCEPTANCE.OA_ID = @OA_ID AND ORDR_ORDER_ACCEPTANCE.PO_REF_NO = ORDR_PURCHASE_ORDER.PO_REF_NO
AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = DIST_DISTRIBUTOR.DISTRIBUTOR_ID
GO

---------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Get_Total_OA_Qty' AND TYPE = 'P')
DROP PROCEDURE Usp_Get_Total_OA_Qty
GO
--sia sia deh gw dah rubah cape-cape ,procedure nya mesti di balikin lagi
CREATE PROCEDURE Usp_Get_Total_OA_Qty
@OA_BRANDPACK_ID VARCHAR(70),
@IsCheking  BIT,@REMARK VARCHAR(150) OUTPUT,
@ResultQty DECIMAL(18,3) OUTPUT
AS
DECLARE @V_BRANDPACK_ID VARCHAR(14),@V_PRICE_PO DECIMAL(16,2),@V_PO_REF_NO VARCHAR(30),
@V_PO_DATE SMALLDATETIME,@V_DISTRIBUTOR_ID VARCHAR(10),@V_PLANTATION_NAME VARCHAR(100),@V_DESCRIPTIONS VARCHAR(150);
SELECT TOP 1 @V_BRANDPACK_ID = BRANDPACK_ID,@V_PRICE_PO = PO_PRICE_PERQTY,@V_PO_REF_NO = PO_REF_NO,
@V_DESCRIPTIONS = DESCRIPTIONS FROM ORDR_PO_BRANDPACK 
WHERE PO_BRANDPACK_ID = (SELECT TOP 1 PO_BRANDPACK_ID FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
AND PO_ORIGINAL_QTY > 0;

SELECT @V_PO_DATE = PO_REF_DATE, @V_DISTRIBUTOR_ID = DISTRIBUTOR_ID FROM ORDR_PURCHASE_ORDER WHERE PO_REF_NO = @V_PO_REF_NO ;

IF @V_DESCRIPTIONS IS NULL
   BEGIN
	IF EXISTS(SELECT TOP 1 PRICE FROM DIST_PLANT_PRICE WHERE PRICE = @V_PRICE_PO AND DISTRIBUTOR_ID = @V_DISTRIBUTOR_ID AND BRANDPACK_ID = @V_BRANDPACK_ID
	          AND START_DATE <= @V_PO_DATE ORDER BY START_DATE DESC)
	BEGIN 
		SELECT PLANTATION_ID FROM DIST_PLANT_PRICE WHERE PRICE = @V_PRICE_PO
		 AND DISTRIBUTOR_ID = @V_DISTRIBUTOR_ID AND BRANDPACK_ID = @V_BRANDPACK_ID
	        AND DATEDIFF(DAY,START_DATE,@V_PO_DATE) <= 31  ORDER BY START_DATE DESC;
		IF(@@ROWCOUNT > 1)
		BEGIN SET @V_PLANTATION_NAME = ''; END
		ELSE
		BEGIN
		 SET @V_PLANTATION_NAME = (SELECT PLANTATION_NAME FROM PLANTATION 
		 WHERE PLANTATION_ID = (SELECT TOP 1 PLANTATION_ID FROM DIST_PLANT_PRICE WHERE PRICE = @V_PRICE_PO
		 AND DISTRIBUTOR_ID = @V_DISTRIBUTOR_ID AND BRANDPACK_ID = @V_BRANDPACK_ID ORDER BY START_DATE DESC));
		END 
             SELECT @REMARK = 'PRICE FROM PLANTATION  ' + @V_PLANTATION_NAME ; 
        END
	ELSE IF EXISTS(SELECT TOP 1 PRICE FROM BRND_PRICE_HISTORY WHERE PRICE = @V_PRICE_PO AND BRANDPACK_ID = @V_BRANDPACK_ID 
               AND START_DATE <= @V_PO_DATE ORDER BY START_DATE DESC)
	BEGIN SELECT @REMARK = 'PRICE FROM FREE MARKET ' ; END
   END
ELSE
BEGIN SELECT @REMARK = '' +  @V_DESCRIPTIONS ; END	
IF (@IsCheking = 1)
  BEGIN
     SELECT @ResultQty = CAST((SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID) AS DECIMAL(18,3))
     + CAST((SELECT QTY_EVEN FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)AS DECIMAL(18,3));
  END
ELSE
  BEGIN
   SELECT @ResultQty = CAST((SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID) AS DECIMAL(18,3))
      + CAST((SELECT QTY_EVEN FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)AS DECIMAL(18,3));
  END

GO

-----------------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENYELEKSI DATA BRANDPACK DI ORDR_PO_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_SelectBrandPack_IN_ORDR_PO_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Sp_SelectBrandPack_IN_ORDR_PO_BRANDPACK
GO
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_SelectBrandPack_IN_ORDR_PO_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Usp_SelectBrandPack_IN_ORDR_PO_BRANDPACK
GO
CREATE PROCEDURE Usp_SelectBrandPack_IN_ORDR_PO_BRANDPACK
@PO_REF_NO VARCHAR(25)
AS
SELECT OPB.PO_BRANDPACK_ID,OPB.PROJ_BRANDPACK_ID,OPB.BRANDPACK_ID,BB.BRANDPACK_NAME FROM ORDR_PO_BRANDPACK OPB 
INNER JOIN BRND_BRANDPACK BB ON OPB.BRANDPACK_ID = BB.BRANDPACK_ID
WHERE  OPB.PO_REF_NO = @PO_REF_NO
GO
--EXEC Sp_SelectBrandPack_IN_ORDR_PO_BRANDPACK
--@PO_REF_NO = 'asasasas',
--@DISTRIBUTOR_ID = 'ANE002IDR'

--PROCEDURE UNTUK MENYELEKSI ROW PRICE_PERQTY,PO_ORIGINAL_QTY PO_BRANDPACK BERDASARKAN PO_BRANDPACK_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Select_QTY_PO_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Sp_Select_QTY_PO_BRANDPACK
GO
CREATE PROCEDURE Sp_Select_QTY_PO_BRANDPACK
@PO_BRANDPACK_ID VARCHAR(39),
@O_PRICE DECIMAL(16,2) OUTPUT,
@O_LEFT_QTY DECIMAL(16,3) OUTPUT,
@O_UNIT VARCHAR(10) OUTPUT
AS
SET NOCOUNT ON;
BEGIN
 	SELECT @O_UNIT  = (SELECT RIGHT(UNIT,5) FROM BRND_BRANDPACK WHERE BRANDPACK_ID = 
			 (SELECT TOP 1 BRANDPACK_ID FROM ORDR_PO_BRANDPACK WHERE PO_BRANDPACK_ID = @PO_BRANDPACK_ID));
        SELECT @O_PRICE = (SELECT TOP 1 PO_PRICE_PERQTY FROM ORDR_PO_BRANDPACK WHERE PO_BRANDPACK_ID = @PO_BRANDPACK_ID);
      
        SELECT @O_LEFT_QTY = ((SELECT PO_ORIGINAL_QTY FROM ORDR_PO_BRANDPACK WHERE PO_BRANDPACK_ID = @PO_BRANDPACK_ID)
	 			- (SELECT ISNULL(SUM(OA_ORIGINAL_QTY),0) FROM ORDR_OA_BRANDPACK WHERE PO_BRANDPACK_ID = @PO_BRANDPACK_ID));
 END
GO
--EXEC Sp_Select_QTY_PO_BRANDPACK @OA_ID = 'OA-1/ggggg',
--@PO_BRANDPACK_ID = 'ggggg00049050MD',--IF @@FETCH_STATUS = 0
--@O_PO_ORIGINAL_QTY = 0,
--@O_OA_ORIGINAL_QTY = 0,
--@O_PRICE = 0,
--@O_LEFT_QTY = 0

----------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK KEBERADAAN ORDR_OA_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_Existing_OA_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Sp_Check_Existing_OA_BRANDPACK
GO
CREATE PROCEDURE Sp_Check_Existing_OA_BRANDPACK
@OA_BRANDPACK_ID VARCHAR(75)
AS
BEGIN
     IF EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID) 
	RETURN(1)
END
RETURN(0)
GO
--EXEC Sp_Check_Existing_OA_BRANDPACK
--@OA_BRANDPACK_ID = 'OA_100030400MD'
---------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGINSERT DATA OA_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Insert_OA_BRANDPACK' AND TYPE ='P')
DROP PROCEDURE Sp_Insert_OA_BRANDPACK
GO
CREATE PROCEDURE Sp_Insert_OA_BRANDPACK
@OA_BRANDPACK_ID VARCHAR(75),
@OA_ID VARCHAR(32),
@PO_BRANDPACK_ID VARCHAR(39),
@OA_ORIGINAL_QTY DECIMAL(18,3),
@OA_PRICE_PERQTY DECIMAL(18,3),
@QTY_EVEN DECIMAL(18,3),
@LEFT_QTY DECIMAL(18,3),
@UNIT VARCHAR(10),
@REMARK VARCHAR(150),
@CREATE_BY VARCHAR(30)
AS
INSERT INTO ORDR_OA_BRANDPACK(OA_BRANDPACK_ID,OA_ID,PO_BRANDPACK_ID,OA_ORIGINAL_QTY,UNIT,OA_PRICE_PERQTY,
QTY_EVEN,LEFT_QTY,REMARK,CREATE_BY,CREATE_DATE)
VALUES(@OA_BRANDPACK_ID,@OA_ID,@PO_BRANDPACK_ID,@OA_ORIGINAL_QTY,@UNIT,@OA_PRICE_PERQTY,
@QTY_EVEN,@LEFT_QTY,@REMARK,@CREATE_BY,GETDATE())
GO
-----------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGUPDATE DATA OA_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Update_OA_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Sp_Update_OA_BRANDPACK
GO
CREATE PROCEDURE Sp_Update_OA_BRANDPACK
@OA_BRANDPACK_ID VARCHAR(75),
@OA_ID VARCHAR(32),
@PO_BRANDPACK_ID VARCHAR(39),
@OA_ORIGINAL_QTY DECIMAL(18,3),
@OA_PRICE_PERQTY DECIMAL(18,3),
@QTY_EVEN DECIMAL(18,3),
@LEFT_QTY DECIMAL(18,3),
@UNIT VARCHAR(10),
@REMARK VARCHAR(150),
@MODIFY_BY VARCHAR(30)
AS
UPDATE ORDR_OA_BRANDPACK SET OA_ID = @OA_ID,PO_BRANDPACK_ID = @PO_BRANDPACK_ID,
OA_ORIGINAL_QTY = @OA_ORIGINAL_QTY,OA_PRICE_PERQTY = @OA_PRICE_PERQTY,UNIT = @UNIT,
QTY_EVEN = @QTY_EVEN,LEFT_QTY = @LEFT_QTY, 
REMARK = @REMARK,MODIFY_BY = @MODIFY_BY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
GO

--PROCEDURE UNTUK MENGECEK REFERENCED DATA OA_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_REFERENCED_OA_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_REFERENCED_OA_BRANDPACK
GO
CREATE PROCEDURE Usp_Check_REFERENCED_OA_BRANDPACK
@OA_BRANDPACK_ID VARCHAR(75)
AS
SET NOCOUNT ON
BEGIN
	IF EXISTS(SELECT OA_BRANDPACK_ID FROM AGREE_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID) 
	   RETURN(1)
	ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
	   RETURN(2)
	ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM MRKT_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID) 
	   RETURN(3)
	ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_REMAINDING WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
		AND FLAG != 'O' AND FLAG != 'RMOA') 
	   RETURN(4)
	ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM SPPB_BRANDPACK WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
	   RETURN(5)
	ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM OTP_DETAIL WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
           RETURN(6)
	ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM DO_TP_DETAIL WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID) 
	   RETURN(7)
	ELSE
 	   RETURN(0)
END
GO

--------PROCEDURE UNTUK MENGECEK DISKON-DISKON YANG ADA UNTUK OA BRANDPACK----------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_OA_BrandPack_Discount' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_OA_BrandPack_Discount
GO
CREATE PROCEDURE Usp_Check_OA_BrandPack_Discount
@OA_BRANDPACK_ID VARCHAR(75)
AS

BEGIN
   IF EXISTS(SELECT OA_BRANDPACK_ID FROM AGREE_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
	RETURN(1)
   ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM MRKT_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
	RETURN(2)
   ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_REMAINDING WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
	AND FLAG != 'RMOA')
	RETURN(3)
   ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID)
	RETURN(4)
   ELSE
	RETURN(0)
END
GO

--PROCEDURE UNTUK MENDELETE DATA OA_BRANDPACK_ID
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Delete_OA_BRANDPACK_ID' AND TYPE = 'P')
DROP PROCEDURE Sp_Delete_OA_BRANDPACK_ID
GO
CREATE PROCEDURE Sp_Delete_OA_BRANDPACK_ID
@OA_BRANDPACK_ID VARCHAR(75)
AS
DELETE FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
GO

--PROCEDURE UNTUK MEMBUAT VIEW DI GRID OA_DISCOUNT
IF EXISTS(SELECT NAME FROM SYS.OBJECTS WHERE NAME = 'Usp_CreateViewOA_DISCOUNT' AND TYPE = 'P')
DROP PROCEDURE Usp_CreateViewOA_DISCOUNT
GO
CREATE PROCEDURE Usp_CreateViewOA_DISCOUNT
@OA_BRANDPACK_ID VARCHAR(75)
AS
  SET NOCOUNT ON
EXECUTE sp_executesql
 N'SET NOCOUNT ON; IF EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID
          = @OA_BRANDPACK_ID)
	BEGIN
           SELECT DISC_DESCRIPTION =  
           CASE
	   WHEN OOBD.OA_RM_ID IS NOT NULL  THEN
	      ''LEFT DISCOUNT FROM OA '' + (SELECT TOP 1 OA_ID AS OA_REF_NO FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = (SELECT TOP 1 OA_BRANDPACK_ID FROM ORDR_OA_REMAINDING
	      WHERE OA_RM_ID = OOBD.OA_RM_ID))
	   WHEN OOBD.AGREE_DISC_HIST_ID IS NOT NULL THEN
	      ''DISCOUNT FROM OA '' + (SELECT TOP 1 OA_ID FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = (SELECT TOP 1 OA_BRANDPACK_ID FROM AGREE_DISC_HISTORY WHERE AGREE_DISC_HIST_ID
	      = OOBD.AGREE_DISC_HIST_ID))
	   WHEN OOBD.MRKT_DISC_HIST_ID IS NOT NULL THEN
	      ''DISCOUNT FROM OA '' + (SELECT TOP 1 OA_ID FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = (SELECT TOP 1 OA_BRANDPACK_ID FROM MRKT_DISC_HISTORY WHERE MRKT_DISC_HIST_ID
	      = OOBD.MRKT_DISC_HIST_ID))
	   WHEN OOBD.MRKT_M_S_ID IS NOT NULL THEN 
	      ''DISCOUNT FROM SALES PROGRAM ''  + (SELECT TOP 1 PROGRAM_ID FROM MRKT_BRANDPACK WHERE PROG_BRANDPACK_ID  
		=(SELECT TOP 1 PROG_BRANDPACK_ID FROM MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = 
		(SELECT TOP 1 PROG_BRANDPACK_DIST_ID FROM MRKT_MARKETING_SAVING WHERE PROG_BRANDPACK_DIST_ID = OOBD.MRKT_M_S_ID)))
	   WHEN OOBD.BRND_B_S_ID IS NOT NULL THEN
	      ''DISCOUNT FROM AGREEMENT '' + (SELECT TOP 1 AGREEMENT_NO FROM AGREE_BRANDPACK_INCLUDE WHERE AGREE_BRANDPACK_ID  
               =(SELECT TOP 1 AGREE_BRANDPACK_ID FROM BRND_BRANDPACK_SAVING WHERE BRND_B_S_ID = OOBD.BRND_B_S_ID))
	   WHEN OOBD.ACHIEVEMENT_BRANDPACK_ID IS NOT NULL THEN
	      ''DISCOUNT FROM AGREEMENT  ''  + (SELECT TOP 1 AGREEMENT_NO FROM ACCRUED_HEADER WHERE ACHIEVEMENT_ID =(SELECT TOP 1 
		ACHIEVEMENT_ID FROM ACCRUED_DETAIL WHERE ACHIEVEMENT_BRANDPACK_ID =  OOBD.ACHIEVEMENT_BRANDPACK_ID))
           END,
	   OOBD.OA_BRANDPACK_DISC_ID,OOBD.OA_BRANDPACK_ID,OPB.BRANDPACK_ID,BB.BRANDPACK_NAME,
	   OOBD.DISC_QTY AS DISC_QUANTITY,OOBD.PRICE_PRQTY,(OOBD.DISC_QTY * OOBD.PRICE_PRQTY) AS TOTAL,
	   OOBD.GQSY_SGT_P_FLAG,ISNULL((SELECT SUM(ADJ_DISC_QTY) FROM ADJUSTMENT_TRANS WHERE OA_BRANDPACK_DISC_ID = OOBD.OA_BRANDPACK_DISC_ID),0)AS ADJUST_QTY, 
	   OOBD.BRND_B_S_ID,OOBD.ACHIEVEMENT_BRANDPACK_ID,OOBD.MRKT_M_S_ID,OOBD.AGREE_DISC_HIST_ID,
	   OOBD.MRKT_DISC_HIST_ID,OOBD.PROJ_DISC_HIST_ID,OOBD.OA_RM_ID
	   FROM ORDR_PO_BRANDPACK OPB INNER JOIN ORDR_OA_BRANDPACK OOB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
	   INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID
	   INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = OPB.BRANDPACK_ID
	   WHERE OOB.OA_BRANDPACK_ID = @OA_BRANDPACK_ID OPTION(KEEP PLAN)
	END
',N'@OA_BRANDPACK_ID VARCHAR(75)',@OA_BRANDPACK_ID = @OA_BRANDPACK_ID
GO

--exec Usp_CreateViewOA_DISCOUNT @OA_BRANDPACK_ID = 'POSMP/0116/0044-00025442'
 
-----------------------------------------------------------------------------------
---------------------PROCEDURE UNTUK MENGECEK QS_FLAG LAST AND NOW AGREEMENT------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Get_Flag_Agrement_First_Last'
	 AND TYPE = 'P')
   DROP PROCEDURE Usp_Get_Flag_Agrement_First_Last
GO
CREATE PROCEDURE Usp_Get_Flag_Agrement_First_Last
@FLAG CHAR(1) OUTPUT,
@LAST_FLAG CHAR(1)OUTPUT,
@DISTRIBUTOR_ID VARCHAR(10),
--@OA_BRANDPACK_ID VARCHAR(70),
@PO_DATE SMALLDATETIME,
@BRANDPACK_ID VARCHAR(14)
AS
SET NOCOUNT ON;
SET @FLAG = (SELECT TOP 1 AA.QS_TREATMENT_FLAG FROM AGREE_AGREEMENT AA INNER JOIN
AGREE_BRANDPACK_INCLUDE ABI
 ON AA.AGREEMENT_NO = ABI.AGREEMENT_NO   INNER JOIN DISTRIBUTOR_AGREEMENT DA
ON DA.AGREEMENT_NO = AA.AGREEMENT_NO WHERE ABI.BRANDPACK_ID = 
@BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND YEAR(AA.END_DATE) >= YEAR(@PO_DATE) 
AND AA.START_DATE <= @PO_DATE ORDER BY AA.END_DATE DESC);

IF (@FLAG IS NOT NULL)
   BEGIN
	SET @LAST_FLAG = (SELECT TOP 1 FLAG FROM(
	SELECT TOP 2 AA.QS_TREATMENT_FLAG AS FLAG,AA.END_DATE FROM AGREE_BRANDPACK_INCLUDE ABI  INNER JOIN
	AGREE_AGREEMENT AA ON AA.AGREEMENT_NO = ABI.AGREEMENT_NO INNER JOIN DISTRIBUTOR_AGREEMENT DA
	ON DA.AGREEMENT_NO = AA.AGREEMENT_NO  WHERE ABI.BRANDPACK_ID = 
	@BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID   AND YEAR(AA.END_DATE) >= YEAR(@PO_DATE) 
	AND AA.START_DATE <= @PO_DATE ORDER BY AA.END_DATE ASC)T_FLAG);
	--SET @LAST_FLAG = (SELECT TOP 1 FLAG FROM #T_FLAG); --ORDER BY #T_FLAG.END_DATESELECT TOP 2 AA.QS_TREATMENT_FLAG FROM 
	--DROP TABLE #T_FLAG;
   END
GO

-------------------------------------------------------------------------------------------------------------

--PROCEDURE UNTUK MENAMPILKAN DATA DI GRIDEX1 UNTUK FORM OA_BRANDPACK
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetViewOA_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Sp_GetViewOA_BRANDPACK
GO
CREATE PROCEDURE Sp_GetViewOA_BRANDPACK
@OA_ID VARCHAR(32)
AS
EXEC sp_executesql
N'SET NOCOUNT ON;
SELECT OOB.OA_BRANDPACK_ID,OOB.OA_ID AS OA_REF_NO,OOB.PO_BRANDPACK_ID,OOB.OA_ORIGINAL_QTY,
OOB.UNIT AS UNIT_ORDER,OOB.OA_PRICE_PERQTY,OPB.BRANDPACK_ID,OPB.PROJ_BRANDPACK_ID,BB.BRANDPACK_NAME,
(OOB.OA_ORIGINAL_QTY * OOB.OA_PRICE_PERQTY) AS TOTAL_PRICE,OOB.QTY_EVEN,OOB.LEFT_QTY,
OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.PROJ_DISC_QTY + OOB.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
(OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.PROJ_DISC_QTY + OOB.OTHER_DISC_QTY) * OOB.OA_PRICE_PERQTY AS TOTAL_AMOUNT_DISC
,OOB.REMARK
FROM ORDR_OA_BRANDPACK OOB WITH(INDEX(IX_ORDR_OA_BRANDPACK)) INNER JOIN ORDR_PO_BRANDPACK OPB
ON OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID INNER JOIN BRND_BRANDPACK BB ON OPB.BRANDPACK_ID = BB.BRANDPACK_ID
WHERE OOB.OA_ID = @OA_ID'
,N'@OA_ID VARCHAR(32)',@OA_ID = @OA_ID
GO


exec Sp_GetViewOA_BRANDPACK @OA_ID = 'po_test_proj_001-00014078'

--PROCEDURE UNTUK MEMVIEW DATA GIVEN YANG BELUM DIAMBIL BERDASARKAN DATA PO_BRANDPACK,DAN DATAGIVEN SUDAH DI GENERATE
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFTGIVENROW' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFTGIVENROW
GO
CREATE PROCEDURE Usp_Select_LEFTGIVENROW
@DISTRIBUTOR_ID VARCHAR(10),
@BRANDPACK_ID VARCHAR(14),
@GQSY_FLAG VARCHAR(5),
@OA_ID VARCHAR(32)
AS
SET NOCOUNT ON
DECLARE @V_OA_DATE DATETIME
SET @V_OA_DATE = (SELECT OA_DATE FROM ORDR_ORDER_ACCEPTANCE WHERE OA_ID = @OA_ID);
SELECT ADH.AGREE_DISC_HIST_ID,ABI.AGREEMENT_NO,OPB.PO_BRANDPACK_ID,BB.BRANDPACK_NAME,BB.BRANDPACK_ID,
OPB.PO_REF_NO,OPO.PO_REF_DATE,ADH.AGREE_BRANDPACK_ID,ADH.OA_BRANDPACK_ID,ADH.AGREE_OA_QTY,ADH.AGREE_OA_DISC_PCT,
ADH.AGREE_DISC_QTY,ADH.AGREE_RELEASE_QTY,ADH.AGREE_LEFT_QTY,ADH.GQSY_FLAG FROM AGREE_DISC_HISTORY ADH INNER JOIN
ORDR_OA_BRANDPACK OOA ON ADH.OA_BRANDPACK_ID = OOA.OA_BRANDPACK_ID INNER JOIN ORDR_PO_BRANDPACK OPB ON OOA.PO_BRANDPACK_ID
= OPB.PO_BRANDPACK_ID INNER JOIN ORDR_PURCHASE_ORDER OPO ON OPB.PO_REF_NO = OPO.PO_REF_NO INNER JOIN ORDR_ORDER_ACCEPTANCE
OOC ON OOA.OA_ID = OOC.OA_ID AND OPO.PO_REF_NO = OOC.PO_REF_NO 
INNER JOIN BRND_BRANDPACK BB ON  OPB.BRANDPACK_ID = BB.BRANDPACK_ID
INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ADH.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
WHERE OPB.BRANDPACK_ID = @BRANDPACK_ID AND OPO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ADH.GQSY_FLAG = 'G'
AND OOC.OA_DATE <= @V_OA_DATE
AND ADH.AGREE_LEFT_QTY > 0 AND YEAR(OOC.OA_DATE) >= YEAR(GETDATE()) -1; 
GO

-------------------------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM sys.objects WHERE NAME = 'Usp_Select_Left_Qty_Agreement_Saving' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_Left_Qty_Agreement_Saving
GO
CREATE PROCEDURE Usp_Select_Left_Qty_Agreement_Saving
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10),
@FLAG VARCHAR(5),
@PO_DATE DATETIME,
@DISC_AGREE_FROM VARCHAR(20)
AS
SET NOCOUNT ON;
DECLARE @V_DISTRIBUTOR_NAME VARCHAR(50),@IA_BRANDPACK_ID VARCHAR(14), @V_BRANDPACK_NAME VARCHAR(100),@V_BRANDPACK_ID VARCHAR(14);
SET @V_DISTRIBUTOR_NAME = (SELECT DISTRIBUTOR_NAME FROM DIST_DISTRIBUTOR WHERE DISTRIBUTOR_ID = @DISTRIBUTOR_ID);
IF (SELECT AllowRules FROM RefBussinesRules WHERE CodeApp = 'MSC0003') = 1
   BEGIN
        SET @V_BRANDPACK_NAME = (SELECT TOP 1 BRANDPACK_NAME FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID);
       SELECT ACRD.ACHIEVEMENT_BRANDPACK_ID,ACRH.AGREEMENT_NO,'DISTRIBUTOR_NAME' = @V_DISTRIBUTOR_NAME,
	'BRANDPACK_NAME' = @V_BRANDPACK_NAME,ACRH.DISPRO AS [DISPRO %],ACRD.DISC_QTY,ACRD.LEFT_QTY,ACRD.RELEASE_QTY,
	'QSY_FLAG' = @FLAG,ACRH.IDAPP
	FROM ACCRUED_HEADER ACRH INNER JOIN ACCRUED_DETAIL ACRD ON ACRH.ACHIEVEMENT_ID = ACRD.ACHIEVEMENT_ID
        WHERE ACRH.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ACRD.BRANDPACK_ID = @BRANDPACK_ID
	AND ACRD.CAN_RELEASE = 1 AND ACRD.LEFT_QTY > 0 AND ACRH.FLAG = @FLAG AND ACRH.AGREEMENT_NO = ANY(SELECT AGREEMENT_NO
	FROM AGREE_AGREEMENT WHERE YEAR(END_DATE) >= YEAR(@PO_DATE) -2);  		
   END
ELSE
   BEGIN
   SET @V_BRANDPACK_NAME = (SELECT TOP 1 BRANDPACK_NAME FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );
   SELECT @IA_BRANDPACK_ID = CASE @V_BRANDPACK_NAME
   WHEN 'GIBGRO 10 SP SACHET 1 KG  @ 1 GR- D' THEN '00898001KD'
   WHEN 'GIBGRO 20% TABLET @ 5 GR - D' THEN '00896005GD'
   ELSE (SELECT TOP 1 BRANDPACK_ID FROM BRND_BRANDPACK WHERE BRANDPACK_NAME = @V_BRANDPACK_NAME 
    AND ((IsActive = 1 AND IsObsolete = 1) OR BRANDPACK_ID <> @BRANDPACK_ID))
   END
   IF(@IA_BRANDPACK_ID IS NOT NULL)
   BEGIN SET @V_BRANDPACK_ID = @IA_BRANDPACK_ID;
	SELECT BBS.BRND_B_S_ID,ABI.AGREEMENT_NO,'DISTRIBUTOR_NAME' = @V_DISTRIBUTOR_NAME,'BRANDPACK_NAME' = @V_BRANDPACK_NAME,
	BBS.AGREE_DISC_PCT AS [DISPRO %],BBS.DISC_QTY,BBS.LEFT_QTY,BBS.RELEASE_QTY,'QSY_FLAG' = @FLAG
	FROM BRND_BRANDPACK_SAVING BBS INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON BBS.AGREE_BRANDPACK_ID
	= ABI.AGREE_BRANDPACK_ID WHERE BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ABI.BRANDPACK_ID = @V_BRANDPACK_ID--@BRANDPACK_ID
	AND BBS.LEFT_QTY > 0 AND BBS.QSY_FLAG = @FLAG AND ABI.AGREEMENT_NO = ANY(SELECT AGREEMENT_NO FROM AGREE_AGREEMENT 
	WHERE YEAR(END_DATE) >= YEAR(@PO_DATE) -2); 
    END
   ELSE BEGIN 
	SET @V_BRANDPACK_ID = @BRANDPACK_ID;
       	SELECT BBS.BRND_B_S_ID,ABI.AGREEMENT_NO,'DISTRIBUTOR_NAME' = @V_DISTRIBUTOR_NAME,'BRANDPACK_NAME' =@V_BRANDPACK_NAME ,
	BBS.AGREE_DISC_PCT AS [DISPRO %],BBS.DISC_QTY,BBS.LEFT_QTY,BBS.RELEASE_QTY,'QSY_FLAG' = @FLAG
	FROM BRND_BRANDPACK_SAVING BBS INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
      	WHERE BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ABI.BRANDPACK_ID = @V_BRANDPACK_ID--@BRANDPACK_ID
      	AND BBS.LEFT_QTY > 0 AND BBS.QSY_FLAG = @FLAG AND ABI.AGREEMENT_NO = ANY(SELECT AGREEMENT_NO FROM AGREE_AGREEMENT 
	WHERE YEAR(END_DATE) >= YEAR(@PO_DATE) -2); 
    END
	
END
GO
--exec Usp_Select_Left_Qty_Agreement_Saving @BRANDPACK_ID = '077018500GD', @DISTRIBUTOR_ID = 'TIR004IDR', @DISC_AGREE_FROM = 'PO', @PO_DATE = 
--'Jul 16 2010 12:00:00:000AM', @FLAG = 'S1'
--PROCEDURE UNTUK MEMVIEW DATA AGREEMENT_DISCOUNT TYPE Q1 DIMANA AGREEMENT SUDAH DI GENERATE TETAPI BELUM DI AMBIL
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_Q1' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_Q1
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_Q1
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON;

--SELECT AGREE_AGREEMENT.AGREEMENT_NO,BRND_BRANDPACK_SAVING.BRND_B_S_ID,BRND_BRANDPACK_SAVING.AGREE_BRANDPACK_ID,
--BRND_BRANDPACK_SAVING.TOTAL_PO_QTY,BRND_BRANDPACK_SAVING.TOTAL_PO_AMOUNT,BRND_BRANDPACK_SAVING.AGREE_DISC_PCT,
--BRND_BRANDPACK_SAVING.DISC_QTY,BRND_BRANDPACK_SAVING.DISC_AMOUNT,BRND_BRANDPACK_SAVING.RELEASE_QTY,
--BRND_BRANDPACK_SAVING.RELEASE_AMOUNT,BRND_BRANDPACK_SAVING.LEFT_QTY,BRND_BRANDPACK_SAVING.LEFT_AMOUNT,BRND_BRANDPACK_SAVING.QSY_FLAG
--FROM AGREE_AGREEMENT,AGREE_BRANDPACK_INCLUDE,BRND_BRANDPACK_SAVING,DISTRIBUTOR_AGREEMENT
--WHERE DISTRIBUTOR_AGREEMENT.AGREEMENT_NO = AGREE_AGREEMENT.AGREEMENT_NO AND DISTRIBUTOR_AGREEMENT.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND AGREE_BRANDPACK_INCLUDE.AGREEMENT_NO = 
--AGREE_AGREEMENT.AGREEMENT_NO AND BRND_BRANDPACK_SAVING.AGREE_BRANDPACK_ID = 
--AGREE_BRANDPACK_INCLUDE.AGREE_BRANDPACK_ID AND AGREE_BRANDPACK_INCLUDE.BRANDPACK_ID = @BRANDPACK_ID
--AND BRND_BRANDPACK_SAVING.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BRND_BRANDPACK_SAVING.QSY_FLAG = 'Q1' AND BRND_BRANDPACK_SAVING.LEFT_QTY > 0
--GO
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
--BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'Q1' AND BBS.LEFT_QTY > 0
--GO



----------------------------------------------------------------------------------------------

--PROCEDURE UNTUK MEMVIEW DATA AGREEMENT DISCOUNT TYPE Q2 BILA SUADAH DI GENERATE BERDASARKAN BRANDPACK_ID
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_Q2' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_Q2
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_Q2
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
---BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'Q2' AND BBS.LEFT_QTY > 0
--GO

--EXEC Sp_Select_LEFT_GIVEN_Q1 @BRANDPACK_ID = '00030400MD',
--@DISTRIBUTOR_ID = 'ANE002IDR'
-------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW DATA AGREEMENT TYPE Q3 BILA SUDAH DI GENERATE BERDASARKAN BRANDPACK_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_Q3' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_Q3
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_Q3
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
--BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'Q3' AND BBS.LEFT_QTY > 0
--GO

-----------------------------------------------------------------------------------------------------

--PROCEDURE UNTUK MEMVIEW DATA AGREEMENT TYPE Q4 BILA SUDAH DIGENERATE BERDASARKAN BRANPACK_ID
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_Q4' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_Q4
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_Q4
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
--BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'Q4' AND BBS.LEFT_QTY > 0
--GO

------------------------------------------------------------------------------------------------

--PROCEDURE UNTUK MEMVIEW DATA AGREEMENT S1 BILA SUDAH DI GENERATE BERDASARKAN BRANPACK_ID
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_S1' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_S1
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_S1
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
--BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'S1' AND BBS.LEFT_QTY > 0
--GO

--exec Sp_select_Left_Given_s1
--@BRANDPACK_ID = '00030400MD',
--@DISTRIBUTOR_ID = 'ANE002IDR'
------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW DATA AGREEMENT S2 BILA SUDAH DI GENERATE BERDASARKAN BRANDPACK_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_S2' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_S2
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_S2
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
--BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'S2' AND BBS.LEFT_QTY > 0
--GO

----------------------------------------------------------------------------------------------------

--PROCEDURE  UNTUK MEMVIEW DATA AGREEMENT YEAR BILA SUDAH DI GENERATE
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_Y'AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_Y
GO
--CREATE PROCEDURE Usp_Select_LEFT_GIVEN_Y
--@BRANDPACK_ID VARCHAR(14),
--@DISTRIBUTOR_ID VARCHAR(10)
--AS
--SET NOCOUNT ON
--SELECT AA.AGREEMENT_NO,BBS.BRND_B_S_ID,BBS.AGREE_BRANDPACK_ID,BBS.TOTAL_PO_QTY,BBS.TOTAL_PO_AMOUNT,
--BBS.AGREE_DISC_PCT,BBS.DISC_QTY,BBS.DISC_AMOUNT,BBS.RELEASE_QTY,BBS.RELEASE_AMOUNT,BBS.LEFT_QTY,BBS.LEFT_AMOUNT,
--BBS.QSY_FLAG
--FROM DISTRIBUTOR_AGREEMENT DA INNER JOIN AGREE_AGREEMENT AA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
--INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO 
--INNER JOIN BRND_BRANDPACK_SAVING BBS ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID
--WHERE ABI.BRANDPACK_ID = @BRANDPACK_ID AND DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
--AND BBS.QSY_FLAG = 'Y' AND BBS.LEFT_QTY > 0
--

--------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW DATA MARKETING GIVEN DISCOUNT BERDASARKAN BRANDPACK_ID
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Select_LEFT_GIVEN_MARKETING' AND TYPE = 'P')
DROP PROCEDURE Usp_Select_LEFT_GIVEN_MARKETING
GO
CREATE PROCEDURE Usp_Select_LEFT_GIVEN_MARKETING
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10),
@SGT_FLAG varchar(2),
@OA_ID VARCHAR(32)
AS
SET NOCOUNT ON ;
DECLARE @V_OA_DATE SMALLDATETIME;


SET @V_OA_DATE = (SELECT OA_DATE FROM ORDR_ORDER_ACCEPTANCE WHERE OA_ID = @OA_ID);
IF NOT EXISTS(SELECT [NAME] FROM TEMPDB..SYSOBJECTS WHERE [NAME] = '##T_SHIP_TO_M' AND TYPE = 'U')
BEGIN
SELECT ST.SHIP_TO_ID,TM.MANAGER INTO TEMPDB..##T_SHIP_TO_M FROM SHIP_TO ST INNER JOIN TERRITORY_MANAGER TM
ON TM.TM_ID = ST.TM_ID WHERE TM.INACTIVE = 0 AND TM.INACTIVE IS NOT NULL;
CREATE CLUSTERED INDEX IX_T_SHIP_TO_M ON TEMPDB..##T_SHIP_TO_M(SHIP_TO_ID)
END

SELECT MDH.MRKT_DISC_HIST_ID,ISNULL(ST.MANAGER,'')AS PROPOSED_BY,MP.PROGRAM_ID,OPB.BRANDPACK_ID,BB.BRANDPACK_NAME,OPB.PO_REF_NO,OPO.PO_REF_DATE,
MDH.OA_BRANDPACK_ID,MDH.PROG_BRANDPACK_DIST_ID,MDH.MRKT_OA_QTY,MDH.MRKT_DISC_PCT,
MDH.MRKT_DISC_QTY,MDH.MRKT_RELEASE_QTY,MDH.MRKT_LEFT_QTY,MDH.SGT_FLAG
FROM MRKT_DISC_HISTORY MDH INNER JOIN ORDR_OA_BRANDPACK OOA ON OOA.OA_BRANDPACK_ID = MDH.OA_BRANDPACK_ID
INNER JOIN ORDR_PO_BRANDPACK OPB ON OOA.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
INNER JOIN BRND_BRANDPACK BB ON OPB.BRANDPACK_ID = BB.BRANDPACK_ID
INNER JOIN ORDR_PURCHASE_ORDER OPO ON OPB.PO_REF_NO = OPO.PO_REF_NO INNER JOIN ORDR_ORDER_ACCEPTANCE OOC
ON OOC.PO_REF_NO = OPO.PO_REF_NO 
AND OOA.OA_ID = OOC.OA_ID
INNER JOIN MRKT_BRANDPACK_DISTRIBUTOR MBD ON MBD.PROG_BRANDPACK_DIST_ID = MDH.PROG_BRANDPACK_DIST_ID
INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
INNER JOIN MRKT_MARKETING_PROGRAM MP ON MB.PROGRAM_ID = MP.PROGRAM_ID
LEFT OUTER JOIN TEMPDB..##T_SHIP_TO_M ST ON ST.SHIP_TO_ID = MBD.SHIP_TO_ID
WHERE OPB.BRANDPACK_ID = @BRANDPACK_ID AND OPO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND MDH.SGT_FLAG = @SGT_FLAG AND OOC.OA_DATE <= @V_OA_DATE
 AND MDH.MRKT_LEFT_QTY > 0
AND YEAR(OOC.OA_DATE) >= YEAR(GETDATE()) -1;

IF EXISTS(SELECT [NAME] FROM TEMPDB..SYSOBJECTS WHERE [NAME] = '##T_SHIP_TO_M' AND TYPE = 'U')
BEGIN
DROP TABLE ##T_SHIP_TO_M;
END

GO

--EXEC Usp_Select_LEFT_GIVEN_MARKETING
--@BRANDPACK_ID = '00540020LD',
--@DISTRIBUTOR_ID = 'MEK002IDR',
--@SGT_FLAG = 'KP',
--@OA_ID = '(003.A)22/12/08-1052'
--DELETE FROM MRKT_DISC_HISTORY WHERE MRKT_DISC_HIST_ID = '1031/NI/X/200800540020LDMEK002IDRMG21/MK/08-066621/MK/0800540020LD'

-----------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW DATA MARKETING TARGET DISCOUNT BERDASARKAN TARGET BERDASARKAN BRANDPACK_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Select_LEFT_TARGET_MARKETING' AND TYPE = 'P')
DROP PROCEDURE Sp_Select_LEFT_TARGET_MARKETING
GO
CREATE PROCEDURE Sp_Select_LEFT_TARGET_MARKETING
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10)
AS
SET NOCOUNT ON
SELECT MRKT_MARKETING_PROGRAM.PROGRAM_ID,MRKT_MARKETING_PROGRAM.PROGRAM_NAME,BRND_BRANDPACK.BRANDPACK_NAME,MRKT_MARKETING_SAVING.MRKT_M_S_ID,
MRKT_MARKETING_SAVING.TOTAL_REACHED_QTY,MRKT_MARKETING_SAVING.TOTAL_REACHED_AMOUNT,MRKT_MARKETING_SAVING.MRKT_DISC_PCT,MRKT_MARKETING_SAVING.MRKT_DISC_QTY,
MRKT_MARKETING_SAVING.DISC_AMOUNT,MRKT_MARKETING_SAVING.MRKT_RELEASE_QTY,MRKT_MARKETING_SAVING.MRKT_RELEASE_AMOUNT,MRKT_MARKETING_SAVING.MRKT_LEFT_QTY,
MRKT_MARKETING_SAVING.MRKT_LEFT_AMOUNT,MRKT_MARKETING_SAVING.ST_FLAG
FROM MRKT_MARKETING_PROGRAM,MRKT_BRANDPACK,BRND_BRANDPACK,MRKT_BRANDPACK_DISTRIBUTOR,MRKT_MARKETING_SAVING
WHERE MRKT_BRANDPACK.BRANDPACK_ID = @BRANDPACK_ID AND MRKT_BRANDPACK.PROGRAM_ID = MRKT_MARKETING_PROGRAM.PROGRAM_ID
AND MRKT_BRANDPACK.BRANDPACK_ID = BRND_BRANDPACK.BRANDPACK_ID AND MRKT_BRANDPACK.PROG_BRANDPACK_ID = 
MRKT_BRANDPACK_DISTRIBUTOR.PROG_BRANDPACK_ID AND MRKT_BRANDPACK_DISTRIBUTOR.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND MRKT_BRANDPACK_DISTRIBUTOR.PROG_BRANDPACK_DIST_ID = MRKT_MARKETING_SAVING.PROG_BRANDPACK_DIST_ID AND 
MRKT_MARKETING_SAVING.MRKT_LEFT_QTY > 0 AND MRKT_MARKETING_SAVING.ST_FLAG = 'MT'
GO

--exec Sp_Select_LEFT_TARGET_MARKETING
--@BRANDPACK_ID = '0060200200MD',
--@DISTRIBUTOR_ID = 'AGR011000'

------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW DATA MARKETING STEPPING DISCOUNT BERDASARKAN BRANDPACK_ID AND DISTRIBUTOR_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Select_LEFT_STEPPING_MARKETING' AND TYPE = 'P')
DROP PROCEDURE Sp_Select_LEFT_STEPPING_MARKETING
GO
CREATE PROCEDURE Sp_Select_LEFT_STEPPING_MARKETING
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10)
AS
SET NOCOUNT ON
SELECT MRKT_MARKETING_PROGRAM.PROGRAM_ID,MRKT_MARKETING_PROGRAM.PROGRAM_NAME,BRND_BRANDPACK.BRANDPACK_NAME,MRKT_MARKETING_SAVING.MRKT_M_S_ID,
MRKT_MARKETING_SAVING.TOTAL_REACHED_QTY,MRKT_MARKETING_SAVING.TOTAL_REACHED_AMOUNT,MRKT_MARKETING_SAVING.MRKT_DISC_PCT,MRKT_MARKETING_SAVING.MRKT_DISC_QTY,
MRKT_MARKETING_SAVING.DISC_AMOUNT,MRKT_MARKETING_SAVING.MRKT_RELEASE_QTY,MRKT_MARKETING_SAVING.MRKT_RELEASE_AMOUNT,MRKT_MARKETING_SAVING.MRKT_LEFT_QTY,
MRKT_MARKETING_SAVING.MRKT_LEFT_AMOUNT,MRKT_MARKETING_SAVING.ST_FLAG
FROM MRKT_MARKETING_PROGRAM,MRKT_BRANDPACK,BRND_BRANDPACK,MRKT_BRANDPACK_DISTRIBUTOR,MRKT_MARKETING_SAVING
WHERE MRKT_BRANDPACK.BRANDPACK_ID = @BRANDPACK_ID AND MRKT_BRANDPACK.PROGRAM_ID = MRKT_MARKETING_PROGRAM.PROGRAM_ID
AND MRKT_BRANDPACK.BRANDPACK_ID = BRND_BRANDPACK.BRANDPACK_ID AND MRKT_BRANDPACK.PROG_BRANDPACK_ID = 
MRKT_BRANDPACK_DISTRIBUTOR.PROG_BRANDPACK_ID AND MRKT_BRANDPACK_DISTRIBUTOR.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND MRKT_BRANDPACK_DISTRIBUTOR.PROG_BRANDPACK_DIST_ID = MRKT_MARKETING_SAVING.PROG_BRANDPACK_DIST_ID AND 
MRKT_MARKETING_SAVING.MRKT_LEFT_QTY > 0 AND MRKT_MARKETING_SAVING.ST_FLAG = 'MS'
GO

--Exec Sp_Select_LEFT_STEPPING_MARKETING
--@BRANDPACK_ID = '00030400MD',
--@DISTRIBUTOR_ID = 'ANE002IDR'
----------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW DATA PROJECT DISCOUNT BERDASARKAN BRANDPACK_ID AND DISTRIBUTOR_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Select_LEFT_PROJECT_DISCOUNT' AND TYPE ='P')
DROP PROCEDURE Sp_Select_LEFT_PROJECT_DISCOUNT
GO
CREATE PROCEDURE Sp_Select_LEFT_PROJECT_DISCOUNT
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10)
AS
SET NOCOUNT ON
SELECT PROJ_DISC_HISTORY.PROJ_DISC_HIST_ID,PROJ_BRANDPACK.BRANDPACK_ID,BRND_BRANDPACK.BRANDPACK_NAME,PROJ_BRANDPACK.PROJ_REF_NO,
PROJ_DISC_HISTORY.PROJ_BRANDPACK_ID,PROJ_DISC_HISTORY.TOTAL_PO_QTY,PROJ_DISC_HISTORY.PROJ_DISC_PCT,PROJ_DISC_HISTORY.PROJ_DISC_QTY,PROJ_DISC_HISTORY.PROJ_RELEASE_QTY,
PROJ_DISC_HISTORY.PROJ_LEFT_QTY
FROM PROJ_DISC_HISTORY,BRND_BRANDPACK,PROJ_PROJECT,PROJ_BRANDPACK
WHERE PROJ_PROJECT.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND PROJ_BRANDPACK.PROJ_REF_NO = PROJ_PROJECT.PROJ_REF_NO
AND PROJ_DISC_HISTORY.PROJ_BRANDPACK_ID = PROJ_BRANDPACK.PROJ_BRANDPACK_ID AND PROJ_BRANDPACK.BRANDPACK_ID = @BRANDPACK_ID AND PROJ_BRANDPACK.BRANDPACK_ID = BRND_BRANDPACK.BRANDPACK_ID AND 
PROJ_DISC_HISTORY.PROJ_LEFT_QTY > 0
GO
-----------
-- EXEC Sp_Select_LEFT_PROJECT_DISCOUNT
--@BRANDPACK_ID = '00030400MD',
--@DISTRIBUTOR_ID = 'ANE002IDR'
--PROCEDURE UNTUK MENGECEK REFERENSI TABLE ANAK DI TABLE AGREE_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_REFERENCED_AGREE_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Check_REFERENCED_AGREE_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Check_REFERENCED_AGREE_DISC_HISTORY
@AGREE_DISC_HIST_ID VARCHAR(115)
AS
BEGIN
IF EXISTS(SELECT AGREE_DISC_HIST_ID FROM ORDR_OA_BRANDPACK_DISC WHERE AGREE_DISC_HIST_ID = @AGREE_DISC_HIST_ID)
  RETURN(1)
ELSE IF EXISTS(SELECT AGREE_DISC_HIST_ID FROM ORDR_OA_REMAINDING WHERE AGREE_DISC_HIST_ID = @AGREE_DISC_HIST_ID)
  RETURN(1)
ELSE
  RETURN(0)
END
GO
--------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK REFERENSI DATA TABLE ANAK DI TABLE MRKT_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_REFERENCED_MRKT_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Check_REFERENCED_MRKT_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Check_REFERENCED_MRKT_DISC_HISTORY
@MRKT_DISC_HIST_ID VARCHAR(115)
AS
BEGIN
     IF EXISTS(SELECT MRKT_DISC_HIST_ID FROM ORDR_OA_BRANDPACK_DISC WHERE MRKT_DISC_HIST_ID = @MRKT_DISC_HIST_ID)
	RETURN(1) 
     ELSE IF EXISTS(SELECT MRKT_DISC_HIST_ID FROM ORDR_OA_REMAINDING WHERE MRKT_DISC_HIST_ID = @MRKT_DISC_HIST_ID)
	RETURN(1)
     ELSE 
        RETURN(0)
   END
GO
-------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK REFERENSI TABLE ANAK DI TABLE PROJ_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_REFERENCED_PROJ_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Check_REFERENCED_PROJ_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Check_REFERENCED_PROJ_DISC_HISTORY
@PROJ_DISC_HIST_ID VARCHAR(66)
AS
BEGIN
     IF EXISTS(SELECT PROJ_DISC_HIST_ID FROM ORDR_OA_BRANDPACK_DISC WHERE PROJ_DISC_HIST_ID = @PROJ_DISC_HIST_ID)
	RETURN(1)
     ELSE IF EXISTS(SELECT PROJ_DISC_HIST_ID FROM ORDR_OA_REMAINDING WHERE PROJ_DISC_HIST_ID = @PROJ_DISC_HIST_ID)
	RETURN(1)
     ELSE
	RETURN(0)
     --IF (SELECT COUNT(PROJ_DISC_HIST_ID) FROM ORDR_OA_BRANDPACK_DISC WHERE PROJ_DISC_HIST_ID = @PROJ_DISC_HIST_ID) > 0
	--RETURN(1)
     --ELSE IF (SELECT COUNT(PROJ_DISC_HIST_ID) FROM  ORDR_OA_REMAINDING WHERE PROJ_DISC_HIST_ID = @PROJ_DISC_HIST_ID) > 0
	--RETURN(2)
END
--RETURN(0)
GO
-------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGINSERT DATA AGREE_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Insert_AGREE_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Insert_AGREE_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Insert_AGREE_DISC_HISTORY
@AGREE_DISC_HIST_ID VARCHAR(115),
@AGREE_BRANDPACK_ID VARCHAR(39),
@OA_BRANDPACK_ID VARCHAR(75),
@GIVEN_ID VARCHAR(44),
@AGREE_OA_QTY DECIMAL(18,3),
@AGREE_OA_DISC_PCT DECIMAL(18,3),
@AGREE_DISC_QTY DECIMAL(18,3),
@AGREE_RELEASE_QTY DECIMAL(18,3),
@AGREE_LEFT_QTY DECIMAL(18,3),
@GQSY_FLAG VARCHAR(5),
@CREATE_BY VARCHAR(30)
AS
SET NOCOUNT ON;
INSERT INTO AGREE_DISC_HISTORY(AGREE_DISC_HIST_ID,AGREE_BRANDPACK_ID,OA_BRANDPACK_ID,GIVEN_ID,
AGREE_OA_QTY,AGREE_OA_DISC_PCT,AGREE_DISC_QTY,AGREE_RELEASE_QTY,AGREE_LEFT_QTY,GQSY_FLAG,CREATE_BY,CREATE_DATE)
VALUES(@AGREE_DISC_HIST_ID,@AGREE_BRANDPACK_ID,@OA_BRANDPACK_ID,@GIVEN_ID,@AGREE_OA_QTY,@AGREE_OA_DISC_PCT,
@AGREE_DISC_QTY,@AGREE_RELEASE_QTY,@AGREE_LEFT_QTY,@GQSY_FLAG,@CREATE_BY,GETDATE());
GO

-------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENDELETE AGREE_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Delete_AGREE_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Delete_AGREE_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Delete_AGREE_DISC_HISTORY
@AGREE_DISC_HIST_ID VARCHAR(115)
AS
DELETE FROM AGREE_DISC_HISTORY WHERE AGREE_DISC_HIST_ID = @AGREE_DISC_HIST_ID
GO


-----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGINSERT DATA MRKT_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Insert_MRKT_DISC_HISTORY' AND TYPE ='P')
DROP PROCEDURE Sp_Insert_MRKT_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Insert_MRKT_DISC_HISTORY
@MRKT_DISC_HIST_ID VARCHAR(115),
@OA_BRANDPACK_ID VARCHAR(75),
@PROG_BRANDPACK_DIST_ID VARCHAR(40),
@MRKT_OA_QTY DECIMAL(18,3),
@MRKT_DISC_PCT DECIMAL(18,3),
@MRKT_DISC_QTY DECIMAL(18,3),
@MRKT_RELEASE_QTY DECIMAL(18,3),
@MRKT_LEFT_QTY DECIMAL(18,3),
@SGT_FLAG VARCHAR(2),
@CREATE_BY VARCHAR(30)
AS
INSERT INTO MRKT_DISC_HISTORY(MRKT_DISC_HIST_ID,OA_BRANDPACK_ID,PROG_BRANDPACK_DIST_ID,
MRKT_OA_QTY,MRKT_DISC_PCT,MRKT_DISC_QTY,MRKT_RELEASE_QTY,MRKT_LEFT_QTY,SGT_FLAG,CREATE_BY,CREATE_DATE)
VALUES(@MRKT_DISC_HIST_ID,@OA_BRANDPACK_ID,@PROG_BRANDPACK_DIST_ID,@MRKT_OA_QTY,@MRKT_DISC_PCT,
@MRKT_DISC_QTY,@MRKT_RELEASE_QTY,@MRKT_LEFT_QTY,@SGT_FLAG,@CREATE_BY,GETDATE())
GO

----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENDELETE MRKT_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Delete_MRKT_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Delete_MRKT_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Delete_MRKT_DISC_HISTORY
@MRKT_DISC_HIST_ID VARCHAR(115)
AS
DELETE FROM MRKT_DISC_HISTORY WHERE MRKT_DISC_HIST_ID = @MRKT_DISC_HIST_ID
GO

-------------------------------------------------------------------------------------
--PROCEDURE UNTUK PROJ_DISC_HISTORY

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Insert_PROJ_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Insert_PROJ_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Insert_PROJ_DISC_HISTORY
@PROJ_DISC_HIST_ID VARCHAR(66),
@PROJ_BRANDPACK_ID VARCHAR(30),
@TOTAL_PO_QTY VARCHAR(14),
@PROJ_DISC_PCT VARCHAR(6),
@PROJ_DISC_QTY VARCHAR(10),
@PROJ_RELEASE_QTY VARCHAR(10),
@PROJ_LEFT_QTY VARCHAR(10),
@CREATE_BY VARCHAR(30)
AS
INSERT INTO PROJ_DISC_HISTORY(PROJ_DISC_HIST_ID,PROJ_BRANDPACK_ID,TOTAL_PO_QTY,
PROJ_DISC_PCT,PROJ_DISC_QTY,PROJ_RELEASE_QTY,PROJ_LEFT_QTY,CREATE_BY,CREATE_DATE)
VALUES(@PROJ_DISC_HIST_ID,@PROJ_BRANDPACK_ID,@TOTAL_PO_QTY,@PROJ_DISC_PCT,@PROJ_DISC_QTY,
@PROJ_RELEASE_QTY,@PROJ_LEFT_QTY,@CREATE_BY,GETDATE())
GO


-----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENDELETE DATA PROJ_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Delete_PROJ_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_Delete_PROJ_DISC_HISTORY
GO
CREATE PROCEDURE Sp_Delete_PROJ_DISC_HISTORY
@PROJ_DISC_HIST_ID VARCHAR(66)
AS
DELETE FROM PROJ_DISC_HISTORY WHERE PROJ_DISC_HIST_ID = @PROJ_DISC_HIST_ID
GO
-----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENDELETE DATA OARDR_OA_BRANDPACK_DISC
--IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Delete_ORDR_OA_BRANDPACK_DISC' AND TYPE = 'P')
--DROP PROCEDURE Sp_Delete_ORDR_OA_BRANDPACK_DISC
--GO
--CREATE PROCEDURE Sp_Delete_ORDR_OA_BRANDPACK_DISC
--@OA_BRANDPACK_DISC_ID UNIQUEIDENTIFIER
--AS
--DELETE FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_DISC_ID = @OA_BRANDPACK_DISC_ID
--GO

-----------------------------------------------------------------------------
--PROCEDURE UNTUK MENGINSERT DATA ORDR_OA_BRANDPACK_DISCOUNT
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Insert_ORDR_OA_BRANDPACK_DISCOUNT' AND TYPE = 'P')
DROP PROCEDURE Usp_Insert_ORDR_OA_BRANDPACK_DISCOUNT
GO
--CREATE PROCEDURE Usp_Insert_ORDR_OA_BRANDPACK_DISCOUNT
----@OA_BRANDPACK_DISC_ID UNIQUEIDENTIFIER,
--@OA_BRANDPACK_ID VARCHAR(75),
--@GQSY_SGT_P_FLAG VARCHAR(5),
--@DISC_QTY DECIMAL(10,3),
--@PRICE_PRQTY DECIMAL(18,3),
--@AGREE_DISC_HIST_ID VARCHAR(115),
--@MRKT_DISC_HIST_ID VARCHAR(115),
--@PROJ_DISC_HIST_ID VARCHAR(66),
--@BRND_B_S_ID VARCHAR(60),
--@MRKT_M_S_ID VARCHAR(60),
--@OA_RM_ID VARCHAR(150),
--@ACHIEVEMENT_BRANDPACK_ID VARCHAR(70),
--@CREATE_BY VARCHAR(30)
--AS
--SET NOCOUNT ON;
--INSERT INTO ORDR_OA_BRANDPACK_DISC(OA_BRANDPACK_ID,GQSY_SGT_P_FLAG,DISC_QTY,
--PRICE_PRQTY,AGREE_DISC_HIST_ID,MRKT_DISC_HIST_ID,PROJ_DISC_HIST_ID,BRND_B_S_ID,ACHIEVEMENT_BRANDPACK_ID,MRKT_M_S_ID,OA_RM_ID,
--CREATE_BY,CREATE_DATE)
--VALUES(@OA_BRANDPACK_ID,@GQSY_SGT_P_FLAG,@DISC_QTY,@PRICE_PRQTY,@AGREE_DISC_HIST_ID,
--@MRKT_DISC_HIST_ID,@PROJ_DISC_HIST_ID,@BRND_B_S_ID,@ACHIEVEMENT_BRANDPACK_ID,@MRKT_M_S_ID,@OA_RM_ID,@CREATE_BY,GETDATE())
--GO
-----------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK DATA BRANDPACK APAKAH ADA DI PROJECT BERDASARKAN BRANDPACK_ID DAN DISTRIBUTOR_ID

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Check_BRANDPACK_ID_IN_PROJ_BRANDPACK' AND TYPE ='P')
DROP PROCEDURE Sp_Check_BRANDPACK_ID_IN_PROJ_BRANDPACK
GO
CREATE PROCEDURE Sp_Check_BRANDPACK_ID_IN_PROJ_BRANDPACK
@OA_BRANDPACK_ID VARCHAR(75),
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10)
AS
SELECT PROJ_BRANDPACK.BRANDPACK_ID,PROJ_BRANDPACK.DISTRIBUTOR_ID
FROM PROJ_BRANDPACK,ORDR_PURCHASE_ORDER,ORDR_PO_BRANDPACK,ORDR_OA_BRANDPACK
WHERE ORDR_OA_BRANDPACK.OA_BRANDPACK_ID = @OA_BRANDPACK_ID AND ORDR_OA_BRANDPACK.PO_BRANDPACK_ID
= ORDR_PO_BRANDPACK.PO_BRANDPACK_ID AND ORDR_PO_BRANDPACK.BRANDPACK_ID = @BRANDPACK_ID AND
ORDR_PO_BRANDPACK.PO_REF_NO = ORDR_PURCHASE_ORDER.PO_REF_NO AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND ORDR_PO_BRANDPACK.BRANDPACK_ID = PROJ_BRANDPACK.BRANDPACK_ID AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = PROJ_BRANDPACK.DISTRIBUTOR_ID
GO


---------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGAMBIL QIVEN QTY FOR DISTRIBUTOR PADA SAAT DI INSERT DI GRID OA_BRANDPACK_DISCOUNT
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_GetTotal_price_for_DISTRIBUTOR' AND TYPE = 'P')
DROP PROCEDURE Usp_GetTotal_price_for_DISTRIBUTOR
GO
CREATE PROCEDURE Usp_GetTotal_price_for_DISTRIBUTOR
@OA_ID VARCHAR(32),
@DISTRIBUTOR_ID VARCHAR(10),
@O_MAX_DISCOUNT DECIMAL(10,3) OUTPUT,
@O_TOTAL_PRICE DECIMAL(18,2) OUTPUT
AS
SET NOCOUNT ON;
BEGIN
  SET @O_TOTAL_PRICE = (SELECT ISNULL(SUM(OA_ORIGINAL_QTY * OA_PRICE_PERQTY),0) FROM ORDR_OA_BRANDPACK WHERE OA_ID = @OA_ID);		
  SET @O_MAX_DISCOUNT = (SELECT MAX_DISC_PER_PO FROM DIST_DISTRIBUTOR WHERE DISTRIBUTOR_ID = @DISTRIBUTOR_ID); 
END
GO

--exec Sp_GetTotal_price_for_DISTRIBUTOR @DISTRIBUTOR_ID = 'IBR001IDR',
--@OA_ID = 'POCOBACOBAAJADEHYAHGUEPUS-0001',
--@PO_REF_NO = 'POCOBACOBAAJADEHYAHGUEPUS',
--@O_TOTAL_QTY = 0,
--@O_MAX_DISCOUNT = 0,
--@O_TOTAL_PRICE = 0

----------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGCEK APAKAH DATA OA_BRANDPACK_ID SUDAH DI GENERATE / BELUM DI TABLE MRKT_DISC_HISTORY

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_HasGenerated_MRK_OA_BRANDPACK_ID' AND TYPE = 'P')
DROP PROCEDURE Sp_HasGenerated_MRK_OA_BRANDPACK_ID
GO
CREATE PROCEDURE Sp_HasGenerated_MRK_OA_BRANDPACK_ID
@OA_BRANDPACK_ID VARCHAR(75),
@SGT_FLAG VARCHAR(5)
AS
BEGIN
IF (@SGT_FLAG IS NULL)
    BEGIN
    	IF EXISTS(SELECT OA_BRANDPACK_ID FROM MRKT_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
	   AND SGT_FLAG IS NULL)
	   RETURN(1)
    END
ELSE IF EXISTS(SELECT OA_BRANDPACK_ID FROM MRKT_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
AND SGT_FLAG = @SGT_FLAG) 
    RETURN(2)
ELSE
    RETURN(0)
END
GO
------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK APAKAH DATA OA_BRANDPACK_ID SUDAH DI GENERATE/BELUM DI TABLE AGREE_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_HasGeneratad_AGREE_OA_BRANDPACK_ID' AND TYPE = 'P')
DROP PROCEDURE Sp_HasGeneratad_AGREE_OA_BRANDPACK_ID
GO
CREATE PROCEDURE Sp_HasGeneratad_AGREE_OA_BRANDPACK_ID
@OA_BRANDPACK_ID VARCHAR(75),
@GQSY_FLAG VARCHAR(5)
AS
SET NOCOUNT ON
BEGIN
     IF EXISTS(SELECT OA_BRANDPACK_ID FROM AGREE_DISC_HISTORY WHERE OA_BRANDPACK_ID = @OA_BRANDPACK_ID
     AND GQSY_FLAG = @GQSY_FLAG) 
	RETURN(1) 
END
RETURN(0)
GO
----------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------

--PROCEDURE UNTUK MENGENERATE DATA AGREEMENT GIVEN                                            
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Generetate_AGREE_GIVEN_DISCOUNT_STAGE_1' AND TYPE = 'P')
DROP PROCEDURE Usp_Generetate_AGREE_GIVEN_DISCOUNT_STAGE_1
GO
CREATE PROCEDURE Usp_Generetate_AGREE_GIVEN_DISCOUNT_STAGE_1
@OA_BRANDPACK_ID VARCHAR(75),
@DISTRIBUTOR_ID VARCHAR(10),
@PO_REF_NO VARCHAR(25),
@BRANDPACK_ID VARCHAR(14),
@O_AGREE_BRANDPACK_ID VARCHAR(39)OUTPUT,
@O_PO_REF_DATE DATETIME OUTPUT,
@O_AGREEMENT_NO VARCHAR(25)OUTPUT,
@O_AGREE_BRAND_ID VARCHAR(32) OUTPUT
AS
SET NOCOUNT ON;
DECLARE @V_BRANDPACK_ID VARCHAR(14);
BEGIN
SET @O_PO_REF_DATE = (SELECT PO_REF_DATE FROM ORDR_PURCHASE_ORDER WHERE PO_REF_NO = @PO_REF_NO)
SET @O_AGREEMENT_NO = (SELECT TOP 1 ABI.AGREEMENT_NO FROM AGREE_BRANDPACK_INCLUDE ABI 
                       INNER JOIN AGREE_AGREEMENT AA ON ABI.AGREEMENT_NO = AA.AGREEMENT_NO
                       INNER JOIN DISTRIBUTOR_AGREEMENT DA ON DA.AGREEMENT_NO = AA.AGREEMENT_NO
                       WHERE DA.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND AA.END_DATE >= @O_PO_REF_DATE
                       AND AA.START_DATE <= @O_PO_REF_DATE AND ABI.BRANDPACK_ID = @BRANDPACK_ID )
SET @O_AGREE_BRANDPACK_ID = (@O_AGREEMENT_NO + '' + @BRANDPACK_ID);
SET @O_AGREE_BRAND_ID = (SELECT AGREE_BRAND_ID FROM AGREE_BRANDPACK_INCLUDE WHERE AGREE_BRANDPACK_ID = 
                         @O_AGREE_BRANDPACK_ID);

IF (@O_AGREEMENT_NO IS NULL)
    BEGIN
	RAISERROR('Could not find AgreementNo between periods',16,1);
	RETURN;
    END
IF (@O_AGREE_BRAND_ID IS NULL)
    BEGIN
	RAISERROR('Could not find AgreementBrand between periods',16,1);
	RETURN;
    END

IF (@O_AGREE_BRANDPACK_ID IS NULL)

    BEGIN
	RAISERROR('Could not find AgreementBrandPack between periods',16,1);
	RETURN;
    END
END
GO


-----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENGGENERATE MARKETING DISCOUNT TAHAP 1

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Generate_MARKETING_GIVEN_DISCOUNT_STAGE_1' AND TYPE = 'P')
DROP PROCEDURE Sp_Generate_MARKETING_GIVEN_DISCOUNT_STAGE_1
GO
CREATE PROCEDURE Sp_Generate_MARKETING_GIVEN_DISCOUNT_STAGE_1 
@OA_BRANDPACK_ID VARCHAR(75),
@DISTRIBUTOR_ID VARCHAR(10),
@PO_REF_NO VARCHAR(25),
@BRANDPACK_ID VARCHAR(14)

AS
BEGIN
SELECT MRKT_BRANDPACK_DISTRIBUTOR.PROG_BRANDPACK_DIST_ID,MRKT_BRANDPACK_DISTRIBUTOR.START_DATE,
MRKT_BRANDPACK_DISTRIBUTOR.END_DATE,MRKT_BRANDPACK_DISTRIBUTOR.GIVEN_DISC_PCT,
MRKT_BRANDPACK_DISTRIBUTOR.TARGET_QTY,MRKT_BRANDPACK_DISTRIBUTOR.TARGET_DISC_PCT,
MRKT_BRANDPACK_DISTRIBUTOR.STEPPING_FLAG,ORDR_PURCHASE_ORDER.PO_REF_DATE,
ORDR_PO_BRANDPACK.PO_PRICE_PERQTY FROM ORDR_OA_BRANDPACK,ORDR_PO_BRANDPACK,ORDR_PURCHASE_ORDER,
MRKT_BRANDPACK_DISTRIBUTOR,MRKT_BRANDPACK
WHERE ORDR_OA_BRANDPACK.OA_BRANDPACK_ID = @OA_BRANDPACK_ID AND ORDR_OA_BRANDPACK.PO_BRANDPACK_ID
= ORDR_PO_BRANDPACK.PO_BRANDPACK_ID AND ORDR_PO_BRANDPACK.PO_REF_NO = @PO_REF_NO 
AND ORDR_PO_BRANDPACK.PO_REF_NO = ORDR_PURCHASE_ORDER.PO_REF_NO AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = MRKT_BRANDPACK_DISTRIBUTOR.DISTRIBUTOR_ID
AND MRKT_BRANDPACK_DISTRIBUTOR.PROG_BRANDPACK_ID = MRKT_BRANDPACK.PROG_BRANDPACK_ID AND ORDR_PO_BRANDPACK.BRANDPACK_ID
= MRKT_BRANDPACK.BRANDPACK_ID AND MRKT_BRANDPACK.BRANDPACK_ID = @BRANDPACK_ID
AND MRKT_BRANDPACK_DISTRIBUTOR.END_DATE >= CAST((SELECT PO_REF_DATE FROM ORDR_PURCHASE_ORDER WHERE PO_REF_NO = @PO_REF_NO) AS DATETIME)
AND MRKT_BRANDPACK_DISTRIBUTOR.START_DATE <= CAST((SELECT PO_REF_DATE FROM ORDR_PURCHASE_ORDER WHERE PO_REF_NO = @PO_REF_NO) AS DATETIME)

END
GO
-----------------------------------------------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Generate_Sales_Discount_Stage_1' AND TYPE = 'P')
DROP PROCEDURE Usp_Generate_Sales_Discount_Stage_1
GO
CREATE PROCEDURE Usp_Generate_Sales_Discount_Stage_1
@DISTRIBUTOR_ID VARCHAR(10),
@BRANDPACK_ID VARCHAR(14),
@PO_REF_NO VARCHAR(25),
@FLAG VARCHAR(2)
AS
SET NOCOUNT ON;
DECLARE @PO_DATE SMALLDATETIME;
SET @PO_DATE = (SELECT PO_REF_DATE FROM ORDR_PURCHASE_ORDER WHERE PO_REF_NO = @PO_REF_NO);
IF (@FLAG = 'KP')
   BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_PKPP,MBD.TARGET_PKPP,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISPKPP = 1 ;
   END
ELSE IF (@FLAG = 'DK')
   BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_DK,MBD.TARGET_DK,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISDK = 1 ;
   END
ELSE IF(@FLAG = 'MG')
	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_DISC_PCT,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND ((MBD.ISRPK = 1) OR (MBD.GIVEN_DISC_PCT > 0))
 	END
ELSE IF(@FLAG = 'CR')
	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CPR,MBD.TARGET_CPR, MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISCPR = 1; 
	END
ELSE IF (@FLAG = 'CP')
   BEGIN
 	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CP,MBD.TARGET_CP,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISCP = 1 AND MBD.ISSCPD = 0 AND MBD.IS_T_TM_DIST = 0;
   END 
ELSE IF(@FLAG = 'CS')
 	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CP AS GIVEN_CPSD,MBD.TARGET_CP,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISCP = 1 AND MBD.ISSCPD = 1 AND MBD.IS_T_TM_DIST = 0;
	END
ELSE IF(@FLAG = 'TD')
	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CP AS GIVEN_CP,MBD.TARGET_CP,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISCP = 1 AND MBD.ISSCPD = 0 AND MBD.IS_T_TM_DIST = 1;
	END 
ELSE IF(@FLAG = 'TS')
	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CP AS GIVEN_CPSD,MBD.TARGET_CP,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISCP = 1 AND MBD.ISSCPD = 1 AND MBD.IS_T_TM_DIST = 1;
	END 
 ELSE IF(@FLAG = 'CD')
	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CPMRT,MBD.TARGET_CPMRT,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.ISCPMRT = 1 AND MBD.IS_T_TM_DIST = 0;
	END
ELSE IF(@FLAG = 'CT')
	BEGIN
	SELECT MBD.PROG_BRANDPACK_DIST_ID,MBD.GIVEN_CPMRT,MBD.TARGET_CPMRT,MBD.START_DATE,MBD.END_DATE FROM MRKT_BRANDPACK_DISTRIBUTOR MBD
 	INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
	WHERE MB.BRANDPACK_ID = @BRANDPACK_ID AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND  MBD.ISCPMRT = 1 AND MBD.IS_T_TM_DIST = 1;
	END
--CP Target CPD hanya ke distributor saja
--CS target CPD(S) hanya ke distributor saja
--TD Target CPD Ke distributor dan TM
--TS Target CPD(S) ke TM dan Distributor
GO

--PROCEDURE UNTUK MENGECEK TARGET_SALES TERCAPAI / TIDAK BERDASARKAN FLAG MRKT
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Get_SUM_PO_QTY_BY_TARGET_SALES' AND TYPE = 'P')
DROP PROCEDURE Usp_Get_SUM_PO_QTY_BY_TARGET_SALES
GO
CREATE PROCEDURE Usp_Get_SUM_PO_QTY_BY_TARGET_SALES
--@DISC_FROM VARCHAR(50),
@FLAG VARCHAR(2),
@PROG_BRANDPACK_DIST_ID VARCHAR(40),
@DISTRIBUTOR_ID VARCHAR(10),
@BRANDPACK_ID VARCHAR(14),
@PO_REF_NO VARCHAR(25),
@O_SUMPO_QTY DECIMAL(18,3) OUTPUT,
@O_TARGET_QTY DECIMAL(18,3) OUTPUT
AS
SET NOCOUNT ON ;
DECLARE @V_START_DATE DATETIME,@V_END_DATE DATETIME,@V_TARGET_QTY DECIMAL(18,3),@V_SUMPO_QTY DECIMAL(18,3),@V_PO_DATE SMALLDATETIME,@V_IS_T_TM_Distributor BIT;
SET @V_PO_DATE = (SELECT PO.PO_REF_DATE FROM ORDR_PURCHASE_ORDER PO WHERE PO_REF_NO = @PO_REF_NO
                   AND EXISTS(SELECT OPB.PO_REF_NO FROM ORDR_PO_BRANDPACK OPB WHERE OPB.PO_REF_NO = PO.PO_REF_NO 
                   		AND EXISTS(SELECT PO_BRANDPACK_ID FROM ORDR_OA_BRANDPACK WHERE PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID)
			      )
		 );
SET @V_SUMPO_QTY = 0;
SELECT @V_START_DATE = START_DATE,@V_END_DATE = END_DATE FROM  Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID);
--	IF (@FLAG = 'CP')
--	BEGIN
--	    SET @V_TARGET_QTY = (SELECT TARGET_CP FROM  Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID WHERE ISCP = 1 AND ISSCPD = 0 AND MBD.IS_T_TM_DIST = 0 ));
--		SET @V_SUMPO_QTY = (SELECT ISNULL(SUM(OOB.OA_ORIGINAL_QTY),0) FROM ORDR_PO_BRANDPACK OPB
--             INNER JOIN ORDR_OA_BRANDPACK OOB ON OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
--             INNER JOIN ORDR_PURCHASE_ORDER PO ON PO.PO_REF_NO = OPB.PO_REF_NO
--             WHERE OPB.PO_REF_NO <> @PO_REF_NO AND PO.PO_REF_DATE >= @V_START_DATE AND PO.PO_REF_DATE <= @V_PO_DATE
--             AND OPB.BRANDPACK_ID = @BRANDPACK_ID AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID); 
    --TOTALKAN SETIAP OA_ORIGINAL_QTY APAKAH SUDAH MENCAPAI TARGET BELUM3
      --JIKA SUM_POQTY + OA_ORIGINAL_QTY BELUM MECAPAI BONUS NILAI = 0
    --JIKA SUM_POQTY + OA_ORIGINAL_QTY >= TARGET_QTY MAKA DISC% * SUMPO_QTY + OA_ORIGINAL_QTY
    --CHECK APAKAH SUDAH ADA DISCOUNT YANG SUDAH DI GENERATE UNTUK FLAG CP
    -- JIKA SUDAH ADA DISCOUNT DI GENERATE HITUNG JUMLAH DISCOUNT SEHARUSNYA TARGET * DISC%
    --JIKA JUMLAH DISC < DISCOUNT SEHARUSNYA MAKA JUMLAH DISCOUNT 
 	---KALO BONUS SUDAH DI GENERATE MAKA TOTALKAN BONUS YANG SUDAH DI BERIKAN APAKAH 
--	ELSE
    IF (@FLAG = 'CR')
	BEGIN
	    SET @V_TARGET_QTY = (SELECT TARGET_CPR FROM  Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID);
	END
	ELSE IF(@FLAG = 'DK')
	BEGIN
	    SET @V_TARGET_QTY = (SELECT TARGET_DK FROM  Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID);
	END
	ELSE IF(@FLAG = 'KP')
	BEGIN
	    SET @V_TARGET_QTY = (SELECT TARGET_PKPP FROM Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID);
	END
--	ELSE IF (@FLAG = 'CS')
--	BEGIN
--	   SET @V_TARGET_QTY = (SELECT TARGET_CP FROM Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID AND ISCP = 1 ISSCPD = 1 IS_T_TM_DIST = 0);
--	END
--    ELSE IF(@FLAG = 'TS') 
--    BEGIN 
--	 SET @V_TARGET_QTY = (SELECT TARGET_CP FROM Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID AND ISCP = 1 AND ISSCPD = 1 AND IS_T_TM_DIST = 1);
--	END 
--    ELSE IF(@FLAG = 'TD')
--    BEGIN 
--	 SET @V_TARGET_QTY = (SELECT TARGET_CP FROM Nufarm.dbo.MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = @PROG_BRANDPACK_DIST_ID AND ISCP = 1 AND ISSCPD = 0 AND IS_T_TM_DIST = 1);
--	END
--	IF(@FLAG = 'CP')
--	BEGIN 
--	
--	END
--	ELSE 	
--    BEGIN
	SET @V_SUMPO_QTY = (SELECT ISNULL(SUM(OOB.OA_ORIGINAL_QTY),0) FROM ORDR_PO_BRANDPACK OPB
                 INNER JOIN ORDR_OA_BRANDPACK OOB ON OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
                
	         INNER JOIN ORDR_PURCHASE_ORDER PO ON PO.PO_REF_NO = OPB.PO_REF_NO
                 WHERE OPB.PO_REF_NO <> @PO_REF_NO AND PO.PO_REF_DATE >= @V_START_DATE AND PO.PO_REF_DATE <= @V_PO_DATE
                 AND OPB.BRANDPACK_ID = @BRANDPACK_ID AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	         AND EXISTS(SELECT GQSY_SGT_P_FLAG FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
                 AND GQSY_SGT_P_FLAG = @FLAG)
                 );
	END
		   
 SET @O_SUMPO_QTY = @V_SUMPO_QTY;
 SET @O_TARGET_QTY = @V_TARGET_QTY;
IF (@V_SUMPO_QTY >= @V_TARGET_QTY)
RETURN(1) ;
ELSE RETURN(0) ;
GO
-----------------------------------------------------------------------------------
--PROCEDURE UNTUK MENYELEK PRICE 
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Select_PRICE_BY_DATE' AND TYPE = 'P')
DROP PROCEDURE Sp_Select_PRICE_BY_DATE
GO
---------------------------------------------------------------------------------------

--PROCEDURE UNTUK MENJUMLAH PRICE YANG TELAH DI BERIKAN BERDASARKAN OA

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetSumPrice_Given_by_OA' AND TYPE = 'P')
DROP PROCEDURE Sp_GetSumPrice_Given_by_OA
GO
CREATE PROCEDURE Sp_GetSumPrice_Given_by_OA
@OA_ID VARCHAR(32),
@SUMPRICE FLOAT OUTPUT
AS
SET NOCOUNT ON;
BEGIN
	SELECT @SUMPRICE = (SELECT ISNULL(SUM(OOBD.DISC_QTY + OOBD.PRICE_PRQTY),0) FROM ORDR_OA_BRANDPACK_DISC OOBD
	INNER JOIN ORDR_OA_BRANDPACK OOB ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID
	WHERE OOBD.GQSY_SGT_P_FLAG != 'RMOA' AND OOB.OA_ID = @OA_ID);
END
GO

--EXEC Sp_GetSumPrice_Given_by_OA
--@OA_ID = 'PPO_AGRO_GEMA-5926',
--@SUMPRICE = 0

---------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MNGECEK TREATMENT_FLAG(REVISI)---------------

--PROCEDURE SP_GetFlagLastAgreement sebelumny hanya diambil berdasarkan parameter distributor_id
--karena adanya agreement group dan 1 distributor dalam 1 tahun ini memeiliki
--banyak agreement jadi paramaternya mesti di tambah berdasarkan brandpack-id

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_GetFlagLastAgreement' AND TYPE = 'P')
DROP PROCEDURE Usp_GetFlagLastAgreement
GO

--CREATE PROCEDURE Usp_GetFlagLastAgreement
--@DISTRIBUTOR_ID VARCHAR(10),
--@BRANDPACK_ID VARCHAR(14),
--@O_QS_FLAG VARCHAR(1) OUTPUT
--AS
--DECLARE @V_QS_TREATMENT_FLAG CHAR(1)
--BEGIN
	--DECLARE QS_CURSOR SCROLL CURSOR FOR
	--SELECT AGREE_AGREEMENT.QS_TREATMENT_FLAG FROM AGREE_BRANDPACK_INCLUDE,AGREE_AGREEMENT,DISTRIBUTOR_AGREEMENT 
	--WHERE AGREE_BRANDPACK_INCLUDE.AGREEMENT_NO = AGREE_AGREEMENT.AGREEMENT_NO AND
	--AGREE_BRANDPACK_INCLUDE.BRANDPACK_ID = @BRANDPACK_ID AND AGREE_AGREEMENT.AGREEMENT_NO =
	--DISTRIBUTOR_AGREEMENT.AGREEMENT_NO AND DISTRIBUTOR_AGREEMENT.DISTRIBUTOR_ID = @DISTRIBUTOR_ID 
	--ORDER BY AGREE_AGREEMENT.END_DATE DESC
	--OPEN QS_CURSOR
	--FETCH ABSOLUTE 2 FROM QS_CURSOR INTO @V_QS_TREATMENT_FLAG
	--IF (@@FETCH_STATUS != 0)
	  --  BEGIN
		--SET @O_QS_FLAG = ''
	   -- END
	--ELSE
	  --  BEGIN
		--SET @O_QS_FLAG = @V_QS_TREATMENT_FLAG
	    --END
	--CLOSE QS_CURSOR
	--DEALLOCATE QS_CURSOR
	--PRINT 'FLAG = ' + @O_QS_FLAG
--END
--GO


--EXEC Usp_GetFlagLastAgreement
--@DISTRIBUTOR_ID = 'ANE002IDR',
--@BRANDPACK_ID = '01008150MD',
--@O_QS_FLAG = ''
--------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW OA_BRANDPACK DI FORM ACCEPTANCE
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Getview_OA_BRANDPACK' AND TYPE = 'P')
DROP PROCEDURE Sp_Getview_OA_BRANDPACK
GO
CREATE PROCEDURE Sp_Getview_OA_BRANDPACK
@DISTRIBUTOR_ID VARCHAR(10),--@AGREEMENT_NO VARCHAR(25),
@GQSY_SGT_P_FLAG VARCHAR(5),
@START_DATE SMALLDATETIME,
@END_DATE SMALLDATETIME
AS
SET NOCOUNT ON;
IF (@GQSY_SGT_P_FLAG IS NOT NULL)
   IF (@GQSY_SGT_P_FLAG = 'CS' OR @GQSY_SGT_P_FLAG = 'TS')
		BEGIN
			SELECT PO.PO_REF_NO,OA.OA_ID AS OA_REF_NO,OA.OA_DATE,BB.BRANDPACK_NAME,OOB.OA_BRANDPACK_ID,OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0) AS QUANTITY,
			(OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0)) * OOB.OA_PRICE_PERQTY AS AMOUNT,OOB.AGREE_DISC_QTY,
			OOB.AGREE_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_AGREE_DISC_QTY,OOB.PROG_DISC_QTY,
			OOB.PROG_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_PROG_DISC_QTY,OOB.OTHER_DISC_QTY,
			OOB.OTHER_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_OTHER_DISC_QTY,
			OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
			(OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY) * OOB.OA_PRICE_PERQTY AS TOTAL_DISC_AMOUNT,
			ISNULL(OOR.LEFT_QTY,0) AS REMAINING,ISNULL(OOR.LEFT_QTY,0) * OOB.OA_PRICE_PERQTY AS AMOUNT_REMAINING
			FROM ORDR_PURCHASE_ORDER PO INNER JOIN ORDR_PO_BRANDPACK OPB ON PO.PO_REF_NO = OPB.PO_REF_NO
			INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = OPB.BRANDPACK_ID INNER JOIN 
			ORDR_ORDER_ACCEPTANCE OA ON PO.PO_REF_NO = OA.PO_REF_NO INNER JOIN ORDR_OA_BRANDPACK OOB
			ON OOB.OA_ID = OA.OA_ID AND OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
			LEFT OUTER JOIN(
					SELECT OA_BRANDPACK_ID,ISNULL(SUM(DISC_QTY),0)AS LEFT_QTY
        					FROM ORDR_OA_BRANDPACK_DISC WHERE GQSY_SGT_P_FLAG = 'RMOA'
					GROUP BY OA_BRANDPACK_ID
         				)OOBD
			ON OOBD.OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			LEFT OUTER JOIN(
					SELECT OA_BRANDPACK_ID,ISNULL(SUM(LEFT_QTY),0)AS LEFT_QTY
					FROM ORDR_OA_REMAINDING GROUP BY OA_BRANDPACK_ID
               				)OOR
			ON OOB.OA_BRANDPACK_ID = OOR.OA_BRANDPACK_ID
			WHERE PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND OA.OA_DATE >= @START_DATE AND OA.OA_DATE <= @END_DATE
				AND EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			   AND GQSY_SGT_P_FLAG IN('TS','CS'))
		END
	 ELSE IF (@GQSY_SGT_P_FLAG = 'CP' OR @GQSY_SGT_P_FLAG = 'TD')
		BEGIN
			SELECT PO.PO_REF_NO,OA.OA_ID AS OA_REF_NO,OA.OA_DATE,BB.BRANDPACK_NAME,OOB.OA_BRANDPACK_ID,OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0) AS QUANTITY,
			(OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0)) * OOB.OA_PRICE_PERQTY AS AMOUNT,OOB.AGREE_DISC_QTY,
			OOB.AGREE_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_AGREE_DISC_QTY,OOB.PROG_DISC_QTY,
			OOB.PROG_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_PROG_DISC_QTY,OOB.OTHER_DISC_QTY,
			OOB.OTHER_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_OTHER_DISC_QTY,
			OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
			(OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY) * OOB.OA_PRICE_PERQTY AS TOTAL_DISC_AMOUNT,
			ISNULL(OOR.LEFT_QTY,0) AS REMAINING,ISNULL(OOR.LEFT_QTY,0) * OOB.OA_PRICE_PERQTY AS AMOUNT_REMAINING
			FROM ORDR_PURCHASE_ORDER PO INNER JOIN ORDR_PO_BRANDPACK OPB ON PO.PO_REF_NO = OPB.PO_REF_NO
			INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = OPB.BRANDPACK_ID INNER JOIN 
			ORDR_ORDER_ACCEPTANCE OA ON PO.PO_REF_NO = OA.PO_REF_NO INNER JOIN ORDR_OA_BRANDPACK OOB
			ON OOB.OA_ID = OA.OA_ID AND OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
			LEFT OUTER JOIN(
					SELECT OA_BRANDPACK_ID,ISNULL(SUM(DISC_QTY),0)AS LEFT_QTY
        					FROM ORDR_OA_BRANDPACK_DISC WHERE GQSY_SGT_P_FLAG = 'RMOA'
					GROUP BY OA_BRANDPACK_ID
         				)OOBD
			ON OOBD.OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			LEFT OUTER JOIN(
					SELECT OA_BRANDPACK_ID,ISNULL(SUM(LEFT_QTY),0)AS LEFT_QTY
					FROM ORDR_OA_REMAINDING GROUP BY OA_BRANDPACK_ID
               				)OOR
			ON OOB.OA_BRANDPACK_ID = OOR.OA_BRANDPACK_ID
			WHERE PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND OA.OA_DATE >= @START_DATE AND OA.OA_DATE <= @END_DATE
				AND EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			   AND GQSY_SGT_P_FLAG IN('TD','CP'))
		END
	 ELSE IF (@GQSY_SGT_P_FLAG = 'CD' OR @GQSY_SGT_P_FLAG = 'CT')
		BEGIN
		SELECT PO.PO_REF_NO,OA.OA_ID AS OA_REF_NO,OA.OA_DATE,BB.BRANDPACK_NAME,OOB.OA_BRANDPACK_ID,OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0) AS QUANTITY,
			(OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0)) * OOB.OA_PRICE_PERQTY AS AMOUNT,OOB.AGREE_DISC_QTY,
			OOB.AGREE_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_AGREE_DISC_QTY,OOB.PROG_DISC_QTY,
			OOB.PROG_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_PROG_DISC_QTY,OOB.OTHER_DISC_QTY,
			OOB.OTHER_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_OTHER_DISC_QTY,
			OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
			(OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY) * OOB.OA_PRICE_PERQTY AS TOTAL_DISC_AMOUNT,
			ISNULL(OOR.LEFT_QTY,0) AS REMAINING,ISNULL(OOR.LEFT_QTY,0) * OOB.OA_PRICE_PERQTY AS AMOUNT_REMAINING
			FROM ORDR_PURCHASE_ORDER PO INNER JOIN ORDR_PO_BRANDPACK OPB ON PO.PO_REF_NO = OPB.PO_REF_NO
			INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = OPB.BRANDPACK_ID INNER JOIN 
			ORDR_ORDER_ACCEPTANCE OA ON PO.PO_REF_NO = OA.PO_REF_NO INNER JOIN ORDR_OA_BRANDPACK OOB
			ON OOB.OA_ID = OA.OA_ID AND OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
			LEFT OUTER JOIN(
					SELECT OA_BRANDPACK_ID,ISNULL(SUM(DISC_QTY),0)AS LEFT_QTY
        					FROM ORDR_OA_BRANDPACK_DISC WHERE GQSY_SGT_P_FLAG = 'RMOA'
					GROUP BY OA_BRANDPACK_ID
         				)OOBD
			ON OOBD.OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			LEFT OUTER JOIN(
					SELECT OA_BRANDPACK_ID,ISNULL(SUM(LEFT_QTY),0)AS LEFT_QTY
					FROM ORDR_OA_REMAINDING GROUP BY OA_BRANDPACK_ID
               				)OOR
			ON OOB.OA_BRANDPACK_ID = OOR.OA_BRANDPACK_ID
			WHERE PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND OA.OA_DATE >= @START_DATE AND OA.OA_DATE <= @END_DATE
				AND EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			   AND GQSY_SGT_P_FLAG IN('CD','CT'))
		END
	ELSE
		BEGIN
		SELECT PO.PO_REF_NO,OA.OA_ID AS OA_REF_NO,OA.OA_DATE,BB.BRANDPACK_NAME,OOB.OA_BRANDPACK_ID,OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0) AS QUANTITY,
		(OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0)) * OOB.OA_PRICE_PERQTY AS AMOUNT,OOB.AGREE_DISC_QTY,
		OOB.AGREE_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_AGREE_DISC_QTY,OOB.PROG_DISC_QTY,
		OOB.PROG_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_PROG_DISC_QTY,OOB.OTHER_DISC_QTY,
		OOB.OTHER_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_OTHER_DISC_QTY,
		OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
		(OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY) * OOB.OA_PRICE_PERQTY AS TOTAL_DISC_AMOUNT,
		ISNULL(OOR.LEFT_QTY,0) AS REMAINING,ISNULL(OOR.LEFT_QTY,0) * OOB.OA_PRICE_PERQTY AS AMOUNT_REMAINING
		FROM ORDR_PURCHASE_ORDER PO INNER JOIN ORDR_PO_BRANDPACK OPB ON PO.PO_REF_NO = OPB.PO_REF_NO
		INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = OPB.BRANDPACK_ID INNER JOIN 
		ORDR_ORDER_ACCEPTANCE OA ON PO.PO_REF_NO = OA.PO_REF_NO INNER JOIN ORDR_OA_BRANDPACK OOB
		ON OOB.OA_ID = OA.OA_ID AND OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
		LEFT OUTER JOIN(
				SELECT OA_BRANDPACK_ID,ISNULL(SUM(DISC_QTY),0)AS LEFT_QTY
        				FROM ORDR_OA_BRANDPACK_DISC WHERE GQSY_SGT_P_FLAG = 'RMOA'
				GROUP BY OA_BRANDPACK_ID
         			)OOBD
		ON OOBD.OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
		LEFT OUTER JOIN(
				SELECT OA_BRANDPACK_ID,ISNULL(SUM(LEFT_QTY),0)AS LEFT_QTY
				FROM ORDR_OA_REMAINDING GROUP BY OA_BRANDPACK_ID
               			)OOR
		ON OOB.OA_BRANDPACK_ID = OOR.OA_BRANDPACK_ID
		WHERE PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND OA.OA_DATE >= @START_DATE AND OA.OA_DATE <= @END_DATE
		AND EXISTS(SELECT OA_BRANDPACK_ID FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
			   AND GQSY_SGT_P_FLAG LIKE @GQSY_SGT_P_FLAG + '%')
	   END
ELSE
 BEGIN
   	SELECT PO.PO_REF_NO,OA.OA_ID AS OA_REF_NO,OA.OA_DATE,BB.BRANDPACK_NAME,OOB.OA_BRANDPACK_ID,OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0) AS QUANTITY,
	(OOB.QTY_EVEN + ISNULL(OOBD.LEFT_QTY,0)) * OOB.OA_PRICE_PERQTY AS AMOUNT,OOB.AGREE_DISC_QTY,
	OOB.AGREE_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_AGREE_DISC_QTY,OOB.PROG_DISC_QTY,
	OOB.PROG_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_PROG_DISC_QTY,OOB.OTHER_DISC_QTY,
	OOB.OTHER_DISC_QTY * OOB.OA_PRICE_PERQTY AS AMOUNT_OTHER_DISC_QTY,
	OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
	(OOB.AGREE_DISC_QTY + OOB.PROG_DISC_QTY + OOB.OTHER_DISC_QTY) * OOB.OA_PRICE_PERQTY AS TOTAL_DISC_AMOUNT,
	ISNULL(OOR.LEFT_QTY,0) AS REMAINING,ISNULL(OOR.LEFT_QTY,0) * OOB.OA_PRICE_PERQTY AS AMOUNT_REMAINING
	FROM ORDR_PURCHASE_ORDER PO INNER JOIN ORDR_PO_BRANDPACK OPB ON PO.PO_REF_NO = OPB.PO_REF_NO
	INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = OPB.BRANDPACK_ID INNER JOIN 
	ORDR_ORDER_ACCEPTANCE OA ON PO.PO_REF_NO = OA.PO_REF_NO INNER JOIN ORDR_OA_BRANDPACK OOB
	ON OOB.OA_ID = OA.OA_ID AND OOB.PO_BRANDPACK_ID = OPB.PO_BRANDPACK_ID
	LEFT OUTER JOIN(
			SELECT OA_BRANDPACK_ID,ISNULL(SUM(DISC_QTY),0)AS LEFT_QTY
               	        FROM ORDR_OA_BRANDPACK_DISC WHERE GQSY_SGT_P_FLAG = 'RMOA'
                	GROUP BY OA_BRANDPACK_ID
                	)OOBD
	ON OOBD.OA_BRANDPACK_ID = OOB.OA_BRANDPACK_ID
	LEFT OUTER JOIN(
			SELECT OA_BRANDPACK_ID,ISNULL(SUM(LEFT_QTY),0)AS LEFT_QTY
			FROM ORDR_OA_REMAINDING
			GROUP BY OA_BRANDPACK_ID
               		)OOR
	ON OOB.OA_BRANDPACK_ID = OOR.OA_BRANDPACK_ID
	WHERE PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND OA.OA_DATE >= @START_DATE AND OA.OA_DATE <= @END_DATE

END
GO
--EXEC Sp_Getview_OA_BRANDPACK
--@DISTRIBUTOR_ID = 'SUR106IDR',
--@GQSY_SGT_P_FLAG = 'CP',
--@START_DATE ='09/09/2009',
--@END_DATE ='09/09/2010'
----------------------------------------------------------------------------
--------PROCEDURE UNTUK MEMVIEW DATA OA_BRANDPACK DENGAN DISTRIBUTORID UNTUK PROJECT

IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_Getview_OA_BRANDPACK_1' AND TYPE = 'P')
DROP PROCEDURE Sp_Getview_OA_BRANDPACK_1
GO
CREATE PROCEDURE Sp_Getview_OA_BRANDPACK_1
@DISTRIBUTOR_ID VARCHAR(10)
AS
SELECT ORDR_OA_BRANDPACK.OA_BRANDPACK_ID,ORDR_OA_BRANDPACK.OA_ID AS OA_REF_NO,ORDR_ORDER_ACCEPTANCE.OA_DATE,BRND_BRANDPACK.BRANDPACK_NAME,
	(ORDR_OA_BRANDPACK.QTY_EVEN + (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = ORDR_OA_BRANDPACK.OA_BRANDPACK_ID AND GQSY_SGT_P_FLAG = 'RMOA')) AS QUANTITY,ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS PRICE,
	(ORDR_OA_BRANDPACK.QTY_EVEN + (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = ORDR_OA_BRANDPACK.OA_BRANDPACK_ID AND GQSY_SGT_P_FLAG = 'RMOA')) * ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS AMOUNT,ORDR_OA_BRANDPACK.AGREE_DISC_QTY,
	ORDR_OA_BRANDPACK.AGREE_DISC_QTY * ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS AMOUNT_AGREE_DISC_QTY,
	ORDR_OA_BRANDPACK.PROG_DISC_QTY,ORDR_OA_BRANDPACK.PROG_DISC_QTY * ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS AMOUNT_PROG_DISC_QTY,
	ORDR_OA_BRANDPACK.PROJ_DISC_QTY,ORDR_OA_BRANDPACK.PROJ_DISC_QTY * ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS AMOUNT_PROJ_DISC_QTY,
	ORDR_OA_BRANDPACK.OTHER_DISC_QTY,ORDR_OA_BRANDPACK.OTHER_DISC_QTY * ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS AMOUNT_OTHER_DISC_QTY,
	ORDR_OA_BRANDPACK.AGREE_DISC_QTY + ORDR_OA_BRANDPACK.PROG_DISC_QTY + ORDR_OA_BRANDPACK.PROJ_DISC_QTY + ORDR_OA_BRANDPACK.OTHER_DISC_QTY AS TOTAL_DISC_QTY,
	(ORDR_OA_BRANDPACK.AGREE_DISC_QTY + ORDR_OA_BRANDPACK.PROG_DISC_QTY + ORDR_OA_BRANDPACK.PROJ_DISC_QTY + ORDR_OA_BRANDPACK.OTHER_DISC_QTY) * ORDR_OA_BRANDPACK.OA_PRICE_PERQTY AS TOTAL_DISC_AMOUNT,
	ORDR_PO_BRANDPACK.PO_REF_NO,ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID
	FROM ORDR_OA_BRANDPACK,ORDR_PO_BRANDPACK,BRND_BRANDPACK,ORDR_PURCHASE_ORDER,ORDR_ORDER_ACCEPTANCE 
	WHERE ORDR_OA_BRANDPACK.PO_BRANDPACK_ID = ORDR_PO_BRANDPACK.PO_BRANDPACK_ID
	AND ORDR_PO_BRANDPACK.PO_REF_NO = ORDR_PURCHASE_ORDER.PO_REF_NO AND ORDR_PO_BRANDPACK.BRANDPACK_ID 
	= BRND_BRANDPACK.BRANDPACK_ID AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
	AND ORDR_ORDER_ACCEPTANCE.PO_REF_NO = ORDR_PO_BRANDPACK.PO_REF_NO AND ORDR_OA_BRANDPACK.OA_ID = ORDR_ORDER_ACCEPTANCE.OA_ID
	AND ORDR_PURCHASE_ORDER.PROJ_REF_NO IS NOT NULL
GO

----------------------------------------------------------------------------------
--EXEC Sp_Getview_OA_BRANDPACK_1
--@DISTRIBUTOR_ID = 'ANE002IDR'
--PROCEDURE UNTUK MEMVIEW DATA AGREE_DISC_HISTORY


--PROCEDURE UNTUK MEMVIEW DATA OTHER_DISC_HISTORY
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetView_OTHER_DISC_HISTORY' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_OTHER_DISC_HISTORY
GO
CREATE PROCEDURE Sp_GetView_OTHER_DISC_HISTORY
@DISTRIBUTOR_ID VARCHAR(10),
@START_DATE SMALLDATETIME,
@END_DATE SMALLDATETIME,
@FLAG VARCHAR(5)
AS
SET NOCOUNT ON;
SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
[TYPE] = CASE OOBD.GQSY_SGT_P_FLAG WHEN 'O' THEN 'OTHER DISCOUNT' WHEN 'ODD' THEN 'OTHER DISCOUNT(DD)' WHEN 'ODR' THEN 'OTHER DISCOUNT(DR)'
WHEN 'OCBD' THEN 'OTHER DISCOUNT(CBD)' END
FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
WHERE OOBD.GQSY_SGT_P_FLAG =@FLAG
AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND PO.PO_REF_DATE >= @START_DATE AND PO.PO_REF_DATE <= @END_DATE;
GO
--EXEC Sp_GetView_OTHER_DISC_HISTORY
--@DISTRIBUTOR_ID = 'ANE002IDR',
--@AGREEMENT_NO = 'ANEKATANI-00001'

--PROCEDURE UNTUK MEMVIEW ORDR_OA_BRANDPACK_DISC.BY AGREE_DISC_HIST_ID
--SELECT NAME FROM sys.objects  WHERE NAME = 'Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_AGREE' AND TYPE = 'P'
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_AGREE' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_AGREE
GO
CREATE PROCEDURE Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_AGREE
@DISTRIBUTOR_ID VARCHAR(10),
@START_DATE SMALLDATETIME,
@END_DATE SMALLDATETIME,
@GQSY_SGT_P_FLAG VARCHAR(5)
AS
SET NOCOUNT ON;
IF (@GQSY_SGT_P_FLAG IS NULL)
   BEGIN
	SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
	[TYPE] = CASE GQSY_SGT_P_FLAG
		WHEN 'Q1' THEN 'QUARTER 1' WHEN 'Q2' THEN 'QUARTER 2' WHEN 'Q3' THEN 'QUARTER 3'
		WHEN 'Q4' THEN 'QUARTER 4' WHEN 'S1' THEN 'SEMESTER 1' WHEN 'S2' THEN 'SEMESTER 2'
		WHEN 'G' THEN 'GIVEN' WHEN 'Y' THEN 'YEARLY' END
	FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
	ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
	INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
	INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
	WHERE OOBD.GQSY_SGT_P_FLAG IN('G','Q1','Q2','Q3','Q4','S1','S2','Y') 
	AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND PO.PO_REF_DATE >= @START_DATE AND PO.PO_REF_DATE <= @END_DATE;
   END
ELSE
   BEGIN
	SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
	[TYPE] = CASE @GQSY_SGT_P_FLAG
		WHEN 'Q1' THEN 'QUARTER 1' WHEN 'Q2' THEN 'QUARTER 2' WHEN 'Q3' THEN 'QUARTER 3'
		WHEN 'Q4' THEN 'QUARTER 4' WHEN 'S1' THEN 'SEMESTER 1' WHEN 'S2' THEN 'SEMESTER 2'
		WHEN 'G' THEN 'GIVEN' WHEN 'Y' THEN 'YEARLY' END
	FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
	ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
	INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
	INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
	WHERE OOBD.GQSY_SGT_P_FLAG LIKE  @GQSY_SGT_P_FLAG + '%'
	AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND PO.PO_REF_DATE >= @START_DATE AND PO.PO_REF_DATE <= @END_DATE;
   END
   GO

--Exec Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_AGREE
--@DISTRIBUTOR_ID = 'ANE002IDR',
--@GQSY_SGT_P_FLAG = 'Q1',

---------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW ORDR_OA_BRANDPACK_DISC_BY_MRKT_DISC_HIST_ID
IF EXISTS(SELECT NAME FROM SYS.SYSOBJECTS WHERE NAME = 'Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_MRKT' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_MRKT
GO
CREATE PROCEDURE Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_MRKT
@DISTRIBUTOR_ID VARCHAR(10),
@START_DATE SMALLDATETIME,
@END_DATE SMALLDATETIME,
@GQSY_SGT_P_FLAG VARCHAR(5)
AS
SET NOCOUNT ON;

IF (@GQSY_SGT_P_FLAG IS NULL)
   BEGIN
	SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
	[TYPE] = CASE GQSY_SGT_P_FLAG
		WHEN 'MG' THEN 'GIVEN_DPRD' WHEN 'CP' THEN 'GIVEN_CP(D)' WHEN 'CS' THEN 'GIVEN_CP(D)S' WHEN 'CR' THEN 'GIVEN_CP(R)'
		WHEN 'DK' THEN 'GIVEN_DK' WHEN 'KP' THEN 'GIVEN_PKPP' WHEN 'TD' THEN  'GIVEN_CP(D)' WHEN 'TS' THEN 'GIVEN_CP(D)S'
		WHEN 'CT' THEN 'GIVEN_CP(R M/T)' WHEN 'CD' THEN 'GIVEN_CP(R M/T)' WHEN 'DN' THEN 'DK(N)'  WHEN 'CA' THEN 'GIVEN_CP(D)AUTO'  END
	FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
	ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
	INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
	INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
	WHERE OOBD.GQSY_SGT_P_FLAG IN('MG','CR','CP','DK','KP','CS','TD','TS','CT','CD','CA') 
	AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND PO.PO_REF_DATE >= @START_DATE AND PO.PO_REF_DATE <= @END_DATE;
   END
ELSE
   BEGIN
	IF (@GQSY_SGT_P_FLAG = 'CS' OR @GQSY_SGT_P_FLAG = 'TS')
	BEGIN
		SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
		[TYPE']= CASE @GQSY_SGT_P_FLAG
			WHEN 'MG' THEN 'GIVEN_DPRD' WHEN 'CP' THEN 'GIVEN_CP(D)' WHEN 'CS' THEN 'GIVEN_CP(D)S' WHEN 'CR' THEN 'GIVEN_CP(R)'
			WHEN 'DK' THEN 'GIVEN_DK' WHEN 'KP' THEN 'GIVEN_PKPP' WHEN 'TD' THEN  'GIVEN_CP(D)' WHEN 'TS' THEN 'GIVEN_CP(D)S' 
			WHEN 'CT' THEN 'GIVEN_CP(R M/T)' WHEN 'CD' THEN 'GIVEN_CP(R M/T)' WHEN 'DN' THEN 'DK(N)'  WHEN 'CA' THEN 'GIVEN_CP(D)AUTO' END
		FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
		ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
		INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
		INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
		WHERE OOBD.GQSY_SGT_P_FLAG IN('CS','TS')
	END
	ELSE IF (@GQSY_SGT_P_FLAG = 'CP' OR @GQSY_SGT_P_FLAG = 'TD')
	BEGIN	
		SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
		[TYPE] = CASE @GQSY_SGT_P_FLAG
			WHEN 'MG' THEN 'GIVEN_DPRD' WHEN 'CP' THEN 'GIVEN_CP(D)' WHEN 'CS' THEN 'GIVEN_CP(D)S' WHEN 'CR' THEN 'GIVEN_CP(R)'
			WHEN 'DK' THEN 'GIVEN_DK' WHEN 'KP' THEN 'GIVEN_PKPP' WHEN 'TD' THEN  'GIVEN_CP(D)' WHEN 'TS' THEN 'GIVEN_CP(D)S' 
		WHEN 'CT' THEN 'GIVEN_CP(R M/T)' WHEN 'CD' THEN 'GIVEN_CP(R M/T)' WHEN 'DN' THEN 'DK(N)'  WHEN 'CA' THEN 'GIVEN_CP(D)AUTO'  END
		FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
		ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
		INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
		INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
		WHERE OOBD.GQSY_SGT_P_FLAG IN('CP','TD')
	END
	ELSE IF(@GQSY_SGT_P_FLAG = 'CD' OR @GQSY_SGT_P_FLAG = 'CT')
	BEGIN
		SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
		[TYPE] = CASE @GQSY_SGT_P_FLAG
			WHEN 'MG' THEN 'GIVEN_DPRD' WHEN 'CP' THEN 'GIVEN_CP(D)' WHEN 'CS' THEN 'GIVEN_CP(D)S' WHEN 'CR' THEN 'GIVEN_CP(R)'
			WHEN 'DK' THEN 'GIVEN_DK' WHEN 'KP' THEN 'GIVEN_PKPP' WHEN 'TD' THEN  'GIVEN_CP(D)' WHEN 'TS' THEN 'GIVEN_CP(D)S' 
			WHEN 'CT' THEN 'GIVEN_CP(R M/T)' WHEN 'CD' THEN 'GIVEN_CP(R M/T)' WHEN 'DN' THEN 'DK(N)'  WHEN 'CA' THEN 'GIVEN_CP(D)AUTO'  END
		FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
		ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
		INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
		INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
		WHERE OOBD.GQSY_SGT_P_FLAG IN('CD','CT')
	END
	ELSE
	BEGIN
		SELECT OOB.OA_BRANDPACK_ID,OOBD.DISC_QTY,OOBD.PRICE_PRQTY,OOBD.DISC_QTY * OOBD.PRICE_PRQTY AS AMOUNT_DISC_PRICE,
		[TYPE] = CASE @GQSY_SGT_P_FLAG
			WHEN 'MG' THEN 'GIVEN_DPRD' WHEN 'CP' THEN 'GIVEN_CP(D)' WHEN 'CS' THEN 'GIVEN_CP(D)S' WHEN 'CR' THEN 'GIVEN_CP(R)'
			WHEN 'DK' THEN 'GIVEN_DK' WHEN 'KP' THEN 'GIVEN_PKPP' WHEN 'TD' THEN  'GIVEN_CP(D)' WHEN 'TS' THEN 'GIVEN_CP(D)S' 
			WHEN 'CT' THEN 'GIVEN_CP(R M/T)' WHEN 'CD' THEN 'GIVEN_CP(R M/T)' WHEN 'DN' THEN 'DK(N)'  WHEN 'CA' THEN 'GIVEN_CP(D)AUTO' END
		FROM ORDR_OA_BRANDPACK OOB INNER JOIN ORDR_OA_BRANDPACK_DISC OOBD 
		ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID 
		INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID
		INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
		WHERE OOBD.GQSY_SGT_P_FLAG LIKE  @GQSY_SGT_P_FLAG + '%'
		AND PO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND PO.PO_REF_DATE >= @START_DATE AND PO.PO_REF_DATE <= @END_DATE;
	END   
END
GO
--EXEC Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_MRKT
--@DISTRIBUTOR_ID = 'ANE002IDR',
--@GQSY_SGT_P_FLAG = 'MS',
--@AGREEMENT_NO = 'ANEKATANI-00001'
------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMVIEW ORDR_OA_BRANDPACK_DISC_BY_PROJ_DISC_HIST_ID
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_PROJ' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_PROJ
GO
CREATE PROCEDURE Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_PROJ
@DISTRIBUTOR_ID VARCHAR(10)
AS
SELECT ORDR_OA_BRANDPACK_DISC.PROJ_DISC_HIST_ID AS CHILD_ID,ORDR_OA_BRANDPACK.OA_BRANDPACK_ID,ORDR_OA_BRANDPACK_DISC.DISC_QTY,ORDR_OA_BRANDPACK_DISC.PRICE_PRQTY,
ORDR_OA_BRANDPACK_DISC.DISC_QTY * ORDR_OA_BRANDPACK_DISC.PRICE_PRQTY AS AMOUNT_DISC_PRICE,ORDR_OA_BRANDPACK_DISC.GQSY_SGT_P_FLAG AS TYPE
FROM ORDR_OA_BRANDPACK_DISC,ORDR_OA_BRANDPACK,ORDR_PO_BRANDPACK,ORDR_PURCHASE_ORDER
WHERE ORDR_OA_BRANDPACK_DISC.OA_BRANDPACK_ID = ORDR_OA_BRANDPACK.OA_BRANDPACK_ID
AND ORDR_OA_BRANDPACK_DISC.GQSY_SGT_P_FLAG LIKE 'P' AND
ORDR_OA_BRANDPACK_DISC.MRKT_DISC_HIST_ID IS NULL AND ORDR_OA_BRANDPACK_DISC.AGREE_DISC_HIST_ID IS NULL
AND ORDR_OA_BRANDPACK_DISC.BRND_B_S_ID IS NULL AND ORDR_OA_BRANDPACK_DISC.MRKT_M_S_ID IS NULL
AND ORDR_OA_BRANDPACK_DISC.GQSY_SGT_P_FLAG != 'O' AND ORDR_OA_BRANDPACK.PO_BRANDPACK_ID = 
ORDR_PO_BRANDPACK.PO_BRANDPACK_ID AND ORDR_PO_BRANDPACK.PO_REF_NO = ORDR_PURCHASE_ORDER.PO_REF_NO
AND ORDR_PURCHASE_ORDER.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
GO
--EXEC Sp_GetView_ORDR_OA_BRANDPACK_DISC_BY_PROJ
--@DISTRIBUTOR_ID = 'ANE002IDR'


--VIEW BUAT OA_HISTORY DI FROM AGREEMENT DETAIL
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Sp_GetView_OA_BY_AGREEMENT_NO' AND TYPE = 'P')
DROP PROCEDURE Sp_GetView_OA_BY_AGREEMENT_NO
GO
CREATE PROCEDURE Sp_GetView_OA_BY_AGREEMENT_NO
@AGREEMENT_NO VARCHAR(25)
AS
SET NOCOUNT ON;
DECLARE @V_START_DATE DATETIME,@V_END_DATE DATETIME
BEGIN
    SET @V_START_DATE = (SELECT START_DATE FROM AGREE_AGREEMENT WHERE AGREEMENT_NO = @AGREEMENT_NO)
    SET @V_END_DATE = (SELECT END_DATE FROM AGREE_AGREEMENT WHERE AGREEMENT_NO = @AGREEMENT_NO)
    SELECT OOB.OA_ID AS OA_REF_NO,BB.BRANDPACK_NAME,OOB.OA_ORIGINAL_QTY AS QUANTITY,OOB.OA_PRICE_PERQTY AS PRICE,
    (OOB.QTY_EVEN + ISNULL(OOBD.DISC_QTY,0)) * OOB.OA_PRICE_PERQTY AS TOTAL FROM ORDR_OA_BRANDPACK OOB
    LEFT OUTER JOIN (SELECT OA_BRANDPACK_ID,ISNULL(SUM(DISC_QTY),0)AS DISC_QTY FROM ORDR_OA_BRANDPACK_DISC GROUP BY OA_BRANDPACK_ID)OOBD 
    ON OOB.OA_BRANDPACK_ID = OOBD.OA_BRANDPACK_ID
    INNER JOIN ORDR_PO_BRANDPACK OPB ON OPB.PO_BRANDPACK_ID = OOB.PO_BRANDPACK_ID 
    INNER JOIN ORDR_PURCHASE_ORDER PO ON OPB.PO_REF_NO = PO.PO_REF_NO
    INNER JOIN AGREE_BRANDPACK_INCLUDE ABI ON ABI.BRANDPACK_ID = OPB.BRANDPACK_ID
    INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = ABI.BRANDPACK_ID
    AND ABI.BRANDPACK_ID = OPB.BRANDPACK_ID
    WHERE PO.PO_REF_DATE  >= @V_START_DATE AND PO.PO_REF_DATE <= @V_END_DATE
    AND ABI.AGREEMENT_NO = @AGREEMENT_NO
END
GO                       
--EXEC Sp_GetView_OA_BY_AGREEMENT_NO 
--@AGREEMENT_NO = 'ANEKATANI-00001'
-----------PROCEDURE UNTUK MENGUPDATE MRKT_MARKETING_SAVING-----------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Update_MRKT_MARKETING_SAVING' AND TYPE = 'P')
DROP PROCEDURE Usp_Update_MRKT_MARKETING_SAVING
GO
---CREATE PROCEDURE Usp_Update_MRKT_MARKETING_SAVING
--@MRKT_M_S_ID VARCHAR(60),
--@OA_BRANDPACK_DISC_QTY VARCHAR(10),
--@MODIFY_BY VARCHAR(30),
--@ISRELEASE BIT
--AS
--BEGIN
--DECLARE @V_PRICE_PERQTY FLOAT,@V_RELEASE_QTY DECIMAL(10,3),@V_LEFT_QTY DECIMAL(10,3),@V_RELEASE_AMOUNT DECIMAL(10,3),@V_LEFT_AMOUNT DECIMAL(10,3)
--SET @V_PRICE_PERQTY = CAST((SELECT PRICE_PERQTY FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) AS FLOAT)
--IF (@ISRELEASE = 1)
  --  BEGIN
	--SET @V_LEFT_QTY = (SELECT MRKT_LEFT_QTY FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) - CAST((@OA_BRANDPACK_DISC_QTY) AS DECIMAL(10,3))
	--SET @V_LEFT_AMOUNT = @V_PRICE_PERQTY * @V_LEFT_QTY
	--SET @V_RELEASE_QTY = (SELECT MRKT_RELEASE_QTY FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) + CAST((@OA_BRANDPACK_DISC_QTY) AS DECIMAL(10,3))
	--SET @V_RELEASE_AMOUNT = @V_PRICE_PERQTY * @V_RELEASE_QTY
    --END 
--ELSE
   -- BEGIN
  --      SET @V_LEFT_QTY = (SELECT MRKT_LEFT_QTY FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) + CAST((@OA_BRANDPACK_DISC_QTY) AS DECIMAL(10,3))
    --    SET @V_LEFT_AMOUNT = @V_PRICE_PERQTY * @V_LEFT_QTY
      --  SET @V_RELEASE_QTY = (SELECT MRKT_RELEASE_QTY FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) - CAST((@OA_BRANDPACK_DISC_QTY) AS DECIMAL(10,3))
       -- SET @V_RELEASE_AMOUNT = @V_PRICE_PERQTY * @V_RELEASE_QTY
   -- END
---UPDATE MRKT_MARKETING_SAVING SET MRKT_LEFT_QTY = @V_LEFT_QTY,MRKT_LEFT_AMOUNT = @V_LEFT_AMOUNT,MRKT_RELEASE_QTY = @V_RELEASE_QTY,
	--MRKT_RELEASE_AMOUNT = @V_RELEASE_AMOUNT,MODIFY_BY = @MODIFY_BY,MODIFY_DATE = GETDATE() WHERE MRKT_M_S_ID = @MRKT_M_S_ID
--END
--GO

----------PROCEDURE UNTUK MENGECEK ADA ATAU TIDAKNYA SALES PROGRAM UNTUK
---MENGENABLEDKAN / TIDAKNYA RDBSTEPPING DAN RDBTDS----------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_BRANDPACK_ID_IN_MRKT_BRANPACK_DISTRIBUTOR' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_BRANDPACK_ID_IN_MRKT_BRANPACK_DISTRIBUTOR
GO
CREATE PROCEDURE Usp_Check_BRANDPACK_ID_IN_MRKT_BRANPACK_DISTRIBUTOR
--@OA_BRANDPACK_ID VARCHAR(70),
@BRANDPACK_ID VARCHAR(14),
@DISTRIBUTOR_ID VARCHAR(10)
AS
SET NOCOUNT ON
SELECT DISTINCT MBD.STEPPING_FLAG FROM MRKT_BRANDPACK_DISTRIBUTOR MBD INNER JOIN MRKT_BRANDPACK MB
ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID INNER JOIN BRND_BRANDPACK BB ON BB.BRANDPACK_ID = MB.BRANDPACK_ID 
WHERE MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND YEAR(MBD.END_DATE) >= YEAR(GETDATE()) -1
GO
-------------------------------------------------------------------------------

-------PROCEDURE UNTUK CONTRAINT AGREE_DISC_QTY-------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Sum_Mathching_Disc_Qty'
 AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Sum_Mathching_Disc_Qty
GO
CREATE PROCEDURE Usp_Check_Sum_Mathching_Disc_Qty
@OA_BRANDPACK_ID VARCHAR(75),
@DISCOUNT_TYPE VARCHAR(50)
AS
EXECUTE sp_executesql
N'SET NOCOUNT ON;
IF (@V_DISCOUNT_TYPE = ''Sales_Discount'')
   BEGIN
 	DECLARE @SUM_PROG_DISC_QTY DECIMAL(18,3),@PROG_DISC_QTY DECIMAL(18,3);
	SET @PROG_DISC_QTY =  (SELECT PROG_DISC_QTY FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID);-- AS DECIMAL(18,3))
	SET @SUM_PROG_DISC_QTY = (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC
	                         WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID AND GQSY_SGT_P_FLAG IN(''MG'',''KP'',''CR'',''CP'',''MS'',''DK'',''CS'',''TD'',''TS'',''CD'',''CT'',''DN'',''CA''));
        UPDATE ORDR_OA_BRANDPACK SET PROG_DISC_QTY = @SUM_PROG_DISC_QTY
		WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID;
		
   END
ELSE IF (@V_DISCOUNT_TYPE = ''Agreement_Discount'')
     BEGIN
	  DECLARE @SUM_AGREE_DISC_QTY DECIMAL(18,3),@AGREE_DISC_QTY DECIMAL(18,3)
	    SET @AGREE_DISC_QTY = (SELECT AGREE_DISC_QTY FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID);-- AS DECIMAL(18,3));
	    SET @SUM_AGREE_DISC_QTY = (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC
            WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID AND GQSY_SGT_P_FLAG IN(''G'',''Q1'',''Q2'',''Q3'',''Q4'',''S1'',''S2'',''Y''));
	    
            UPDATE ORDR_OA_BRANDPACK SET AGREE_DISC_QTY = @SUM_AGREE_DISC_QTY
	    WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID;
     END
ELSE IF (@V_DISCOUNT_TYPE = ''Other_Discount'')
      BEGIN
	   DECLARE @SUM_OTHER_DISC_QTY DECIMAL(18,3),@OTHER_DISC_QTY DECIMAL(18,3);
	     SET @OTHER_DISC_QTY = CAST((SELECT OTHER_DISC_QTY FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID) AS DECIMAL(18,3));
	     SET @SUM_OTHER_DISC_QTY = (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC
	     WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID AND GQSY_SGT_P_FLAG IN(''O'',''OCBD'',''ODD'',''ODR'',''ODK'',''ODP''));   
	    
             UPDATE ORDR_OA_BRANDPACK SET OTHER_DISC_QTY = @SUM_OTHER_DISC_QTY
		   WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID;
      END
ELSE IF (@V_DISCOUNT_TYPE = ''Project_Discount'')
     BEGIN
	  DECLARE @SUM_PROJ_DISC_QTY DECIMAL(18,3),@PROJ_DISC_QTY DECIMAL(18,3);
	     SET @PROJ_DISC_QTY = CAST((SELECT PROJ_DISC_QTY FROM ORDR_OA_BRANDPACK WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID) AS DECIMAL(18,3));
             SET @SUM_PROJ_DISC_QTY = CAST((SELECT ISNULL(SUM(DISC_QTY),0)
	        FROM ORDR_OA_BRANDPACK_DISC WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID AND
	        GQSY_SGT_P_FLAG = ''P'')AS DECIMAL(18,3));
	     UPDATE ORDR_OA_BRANDPACK SET PROJ_DISC_QTY = @SUM_PROJ_DISC_QTY 
		   WHERE OA_BRANDPACK_ID = @V_OA_BRANDPACK_ID;	
      END',N'@V_OA_BRANDPACK_ID VARCHAR(70),@V_DISCOUNT_TYPE VARCHAR(50)',
     @V_OA_BRANDPACK_ID = @OA_BRANDPACK_ID,@V_DISCOUNT_TYPE = @DISCOUNT_TYPE;         	
GO

---------------------PROCEDURE UNTUK MEMFIX SUM BRND_BRANDPACK_SAVING----------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Sum_Matching_Disc_Qty_Agreement_Saving' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Sum_Matching_Disc_Qty_Agreement_Saving
GO
CREATE PROCEDURE Usp_Check_Sum_Matching_Disc_Qty_Agreement_Saving
@BRND_B_S_ID VARCHAR(60),
@ACHIEVEMENT_BRANDPACK_ID VARCHAR(70),
@DISC_FROM VARCHAR(20)
AS
EXECUTE sp_executesql
N'SET NOCOUNT ON;
DECLARE @V_RELEASE_QTY DECIMAL(18,3),@V_LEFT_QTY DECIMAL(18,3),@V_DISC_QTY DECIMAL(18,3),
@SUM_RELEASE_QTY DECIMAL(18,3)
BEGIN
  IF (@V_DISC_FROM = ''PO'')
     BEGIN
  	SET @V_DISC_QTY = (SELECT ISNULL(DISC_QTY,0) FROM BRND_BRANDPACK_SAVING WHERE BRND_B_S_ID = @V_BRND_B_S_ID); 
  	SET @V_RELEASE_QTY =(SELECT ISNULL(RELEASE_QTY,0) FROM BRND_BRANDPACK_SAVING WHERE BRND_B_S_ID = @V_BRND_B_S_ID);
  	SET @V_LEFT_QTY = (SELECT ISNULL(LEFT_QTY,0) FROM BRND_BRANDPACK_SAVING WHERE BRND_B_S_ID = @V_BRND_B_S_ID);
  	SET @SUM_RELEASE_QTY = (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE BRND_B_S_ID = @V_BRND_B_S_ID) +
                         (SELECT ISNULL(SUM(QTY),0) FROM ORDR_OA_REMAINDING WHERE BRND_B_S_ID = @V_BRND_B_S_ID);
       	UPDATE BRND_BRANDPACK_SAVING SET RELEASE_QTY = @SUM_RELEASE_QTY,
	LEFT_QTY = (@V_DISC_QTY - @SUM_RELEASE_QTY) WHERE BRND_B_S_ID = @V_BRND_B_S_ID;
       	 
      END
  ELSE
    BEGIN
	SET @V_DISC_QTY = (SELECT ISNULL(DISC_QTY,0) FROM ACCRUED_DETAIL WHERE ACHIEVEMENT_BRANDPACK_ID = @V_ACHIEVEMENT_BRANDPACK_ID); 
  	SET @V_RELEASE_QTY =(SELECT ISNULL(RELEASE_QTY,0) FROM ACCRUED_DETAIL WHERE ACHIEVEMENT_BRANDPACK_ID = @V_ACHIEVEMENT_BRANDPACK_ID); 
  	SET @V_LEFT_QTY = (SELECT ISNULL(LEFT_QTY,0)  FROM ACCRUED_DETAIL WHERE ACHIEVEMENT_BRANDPACK_ID = @V_ACHIEVEMENT_BRANDPACK_ID); 
  	SET @SUM_RELEASE_QTY = (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE ACHIEVEMENT_BRANDPACK_ID = @V_ACHIEVEMENT_BRANDPACK_ID) +
                         (SELECT ISNULL(SUM(QTY),0) FROM ORDR_OA_REMAINDING WHERE ACHIEVEMENT_BRANDPACK_ID = @V_ACHIEVEMENT_BRANDPACK_ID);
        UPDATE ACCRUED_DETAIL SET RELEASE_QTY = @SUM_RELEASE_QTY,
		LEFT_QTY = (@V_DISC_QTY - @SUM_RELEASE_QTY) WHERE ACHIEVEMENT_BRANDPACK_ID = @V_ACHIEVEMENT_BRANDPACK_ID;
    END			
END',N'@V_BRND_B_S_ID VARCHAR(60),@V_DISC_FROM VARCHAR(20),@V_ACHIEVEMENT_BRANDPACK_ID VARCHAR(70)',
@V_BRND_B_S_ID = @BRND_B_S_ID,@V_ACHIEVEMENT_BRANDPACK_ID = @ACHIEVEMENT_BRANDPACK_ID,@V_DISC_FROM = @DISC_FROM;
GO

--PROCEDURE UNTUK MEMFIX SUM MRKT_MARKETING_SAVING--------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Sum_Matching_Disc_Qty_MRKT_M_S_ID' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Sum_Matching_Disc_Qty_MRKT_M_S_ID
GO
CREATE PROCEDURE Usp_Check_Sum_Matching_Disc_Qty_MRKT_M_S_ID
@MRKT_M_S_ID VARCHAR(60)
AS
DECLARE @V_RELEASE_QTY DECIMAL(18,3),@V_LEFT_QTY DECIMAL(18,3),@V_DISC_QTY DECIMAL(18,3),
@SUM_RELEASE_QTY DECIMAL(18,3)

BEGIN
  SET @V_DISC_QTY = CAST((SELECT ISNULL(MRKT_DISC_QTY,0) FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) AS DECIMAL(18,3)) 
  SET @V_RELEASE_QTY = CAST((SELECT ISNULL(MRKT_RELEASE_QTY,0) FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) AS DECIMAL(18,3))
  SET @V_LEFT_QTY = CAST((SELECT ISNULL(MRKT_LEFT_QTY,0) FROM MRKT_MARKETING_SAVING WHERE MRKT_M_S_ID = @MRKT_M_S_ID) AS DECIMAL(18,3))
  SET @SUM_RELEASE_QTY = CAST((SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE MRKT_M_S_ID = @MRKT_M_S_ID)AS DECIMAL(18,3))+
                         CAST((SELECT ISNULL(SUM(QTY),0) FROM ORDR_OA_REMAINDING WHERE MRKT_M_S_ID = @MRKT_M_S_ID)AS DECIMAL(18,3))
  IF (@SUM_RELEASE_QTY <> @V_RELEASE_QTY)
     BEGIN
	UPDATE MRKT_MARKETING_SAVING SET MRKT_RELEASE_QTY = @SUM_RELEASE_QTY,MRKT_LEFT_QTY = (@V_DISC_QTY - @SUM_RELEASE_QTY)
	WHERE MRKT_M_S_ID = @MRKT_M_S_ID
     END
  ELSE
     BEGIN 
 	PRINT 'Sum Release_QTY is Matched' + '  Sum Disc_Qty = ' + cast((@SUM_RELEASE_QTY) AS VARCHAR(13))
     END
END
GO
--------------------------------------------------------------------------------------------
----PROCEDURE UNTUK MEMFIX DISCOUNT MRKT_DISC_HIST_ID-------------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Sum_Disc_Qty_AGREE_DISC_HIST_ID' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Sum_Disc_Qty_AGREE_DISC_HIST_ID
GO
CREATE PROCEDURE Usp_Check_Sum_Disc_Qty_AGREE_DISC_HIST_ID
@AGREE_DISC_HIST_ID VARCHAR(115)
AS
EXECUTE Sp_executesql
N'SET NOCOUNT ON;
DECLARE @V_RELEASE_QTY DECIMAL(18,3),@V_LEFT_QTY DECIMAL(18,3),@V_DISC_QTY DECIMAL(18,3),
@SUM_RELEASE_QTY DECIMAL(18,3)
BEGIN
  SET @V_DISC_QTY = CAST((SELECT ISNULL(AGREE_DISC_QTY,0) FROM AGREE_DISC_HISTORY WHERE AGREE_DISC_HIST_ID = @V_AGREE_DISC_HIST_ID) AS DECIMAL(18,3)); 
  SET @V_RELEASE_QTY = CAST((SELECT ISNULL(AGREE_RELEASE_QTY,0) FROM AGREE_DISC_HISTORY WHERE AGREE_DISC_HIST_ID = @V_AGREE_DISC_HIST_ID) AS DECIMAL(18,3));
  SET @V_LEFT_QTY = CAST((SELECT ISNULL(AGREE_LEFT_QTY,0) FROM AGREE_DISC_HISTORY WHERE AGREE_DISC_HIST_ID = @V_AGREE_DISC_HIST_ID) AS DECIMAL(18,3));
  SET @SUM_RELEASE_QTY = CAST((SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE AGREE_DISC_HIST_ID = @V_AGREE_DISC_HIST_ID)AS DECIMAL(18,3))+
                         CAST((SELECT ISNULL(SUM(QTY),0) FROM ORDR_OA_REMAINDING WHERE AGREE_DISC_HIST_ID = @V_AGREE_DISC_HIST_ID)AS DECIMAL(18,3));
  IF (@SUM_RELEASE_QTY <> @V_RELEASE_QTY)
     BEGIN
	UPDATE AGREE_DISC_HISTORY SET AGREE_RELEASE_QTY = @SUM_RELEASE_QTY,
	AGREE_LEFT_QTY = (@V_DISC_QTY - @SUM_RELEASE_QTY) WHERE AGREE_DISC_HIST_ID = @V_AGREE_DISC_HIST_ID;
     END
END',N'@V_AGREE_DISC_HIST_ID VARCHAR(115)',@V_AGREE_DISC_HIST_ID = @AGREE_DISC_HIST_ID

-------------------------------------------------------------------------------------------------
--PROCEDURE UNTUK MEMFIX DISCOUNT MRKT_DISC_HISTORY -----------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Sum_Disc_Qty_MRKT_DISC_HISTORY'
   AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Sum_Disc_Qty_MRKT_DISC_HISTORY
GO
CREATE PROCEDURE Usp_Check_Sum_Disc_Qty_MRKT_DISC_HISTORY
@MRKT_DISC_HIST_ID VARCHAR(115)
AS
EXECUTE sp_executesql
N'SET NOCOUNT ON;
DECLARE @V_RELEASE_QTY DECIMAL(18,3),@V_LEFT_QTY DECIMAL(18,3),@V_DISC_QTY DECIMAL(18,3),
@SUM_RELEASE_QTY DECIMAL(18,3)
BEGIN
  SELECT @V_DISC_QTY = ISNULL(MRKT_DISC_QTY,0),@V_RELEASE_QTY = ISNULL(MRKT_RELEASE_QTY,0),
  @V_LEFT_QTY = ISNULL(MRKT_LEFT_QTY,0) FROM MRKT_DISC_HISTORY WHERE MRKT_DISC_HIST_ID = @V_MRKT_DISC_HIST_ID; 
  SET @SUM_RELEASE_QTY = CAST((SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE MRKT_DISC_HIST_ID = @V_MRKT_DISC_HIST_ID)AS DECIMAL(18,3))+
                         CAST((SELECT ISNULL(SUM(QTY),0) FROM ORDR_OA_REMAINDING WHERE MRKT_DISC_HIST_ID = @V_MRKT_DISC_HIST_ID)AS DECIMAL(18,3))
  IF (@SUM_RELEASE_QTY <> @V_RELEASE_QTY)
     BEGIN
	UPDATE MRKT_DISC_HISTORY SET MRKT_RELEASE_QTY = @SUM_RELEASE_QTY,
	MRKT_LEFT_QTY = (@V_DISC_QTY - @SUM_RELEASE_QTY) WHERE MRKT_DISC_HIST_ID = @V_MRKT_DISC_HIST_ID
     END
END',N'@V_MRKT_DISC_HIST_ID VARCHAR(115)',@V_MRKT_DISC_HIST_ID = @MRKT_DISC_HIST_ID;
GO

---------------------------------------------------------------------------------------------
---------------------------PROCEDURE UNTUK MEMBUAT MATCHING DISC_QTY OA_REMAINDING-----------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Sum_Mathing_Qty_ORDDR_OA_REMAINDING' AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Sum_Mathing_Qty_ORDDR_OA_REMAINDING
GO
CREATE PROCEDURE Usp_Check_Sum_Mathing_Qty_ORDDR_OA_REMAINDING
@OA_RM_ID VARCHAR(200)
AS
EXECUTE sp_executesql
N'SET NOCOUNT ON;
DECLARE @V_RELEASE_QTY DECIMAL(18,3),@V_LEFT_QTY DECIMAL(18,3),@V_DISC_QTY DECIMAL(18,3),
@SUM_RELEASE_QTY DECIMAL(18,3)--,@V_RELOTHEROA_QTY DECIMAL(13,3)
BEGIN
   --SET @V_RELOTHEROA_QTY = CAST((SELECT RELOTHEROA_QTY FROM ORDR_OA_REMAINDING WHERE OA_RM_ID = @OA_RM_ID) AS DECIMAL(13,3))
   SET @V_DISC_QTY = (SELECT ISNULL(QTY,0) FROM ORDR_OA_REMAINDING WHERE OA_RM_ID = @V_OA_RM_ID)
   SET @V_RELEASE_QTY = (SELECT ISNULL(RELEASE_QTY,0) FROM ORDR_OA_REMAINDING WHERE OA_RM_ID = @V_OA_RM_ID)
   SET @V_LEFT_QTY = (SELECT ISNULL(LEFT_QTY,0) FROM ORDR_OA_REMAINDING WHERE OA_RM_ID = @V_OA_RM_ID)
   SET @SUM_RELEASE_QTY = (SELECT ISNULL(SUM(DISC_QTY),0) FROM ORDR_OA_BRANDPACK_DISC WHERE OA_RM_ID = @V_OA_RM_ID)
    IF (@SUM_RELEASE_QTY <> @V_RELEASE_QTY)
	BEGIN
	    UPDATE ORDR_OA_REMAINDING SET RELEASE_QTY = @SUM_RELEASE_QTY,LEFT_QTY = @V_DISC_QTY - @SUM_RELEASE_QTY--(()- @V_RELOTHEROA_QTY)
	    WHERE OA_RM_ID = @V_OA_RM_ID 	
	END 
END',N'@V_OA_RM_ID VARCHAR(150)',@V_OA_RM_ID = @OA_RM_ID;

--------------PROCEDURE UNTUK MEMVIEW OA_SHIP_TO DI GRIDEX3 DI FORM Acceptance--------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Create_View_OA_Ship_To' AND TYPE = 'P')
DROP PROCEDURE Usp_Create_View_OA_Ship_To
GO
CREATE PROCEDURE Usp_Create_View_OA_Ship_To
@DISTRIBUTOR_ID VARCHAR(10),
@START_DATE SMALLDATETIME,
@END_DATE SMALLDATETIME
AS
SET NOCOUNT ON;
SELECT OPO.PO_REF_NO,OOA.OA_ID AS OA_REF_NO,OOA.OA_DATE,
DR.DISTRIBUTOR_ID AS SHIP_TO_DISTRIBUTOR_ID,DR.DISTRIBUTOR_NAME AS SHIP_TO_DISTRIBUTOR_NAME,
TER.TERRITORY_AREA AS TERRITORY_AREA,TM.MANAGER AS SHIP_TO_TM
FROM ORDR_PURCHASE_ORDER OPO INNER JOIN ORDR_ORDER_ACCEPTANCE OOA ON OPO.PO_REF_NO = OOA.PO_REF_NO
INNER JOIN OA_SHIP_TO OST ON OOA.OA_ID = OST.OA_ID LEFT OUTER JOIN SHIP_TO ST
ON ST.SHIP_TO_ID = OST.SHIP_TO_ID INNER JOIN DIST_DISTRIBUTOR DR
ON OPO.DISTRIBUTOR_ID = DR.DISTRIBUTOR_ID LEFT OUTER JOIN TERRITORY_MANAGER TM ON ST.TM_ID = TM.TM_ID
LEFT OUTER JOIN TERRITORY TER ON ST.TERRITORY_ID
 = TER.TERRITORY_ID 
WHERE OPO.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND OOA.OA_DATE >= @START_DATE AND 
OOA.OA_DATE <= @END_DATE;
GO
----------------------------------------------------------------------------
--PROCEDURE UNTUK MENGECEK DISC_QTY AGREEMENT SAVING
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Availability_Disc_Agreement' AND TYPE = 'P')
BEGIN
DROP PROCEDURE Usp_Check_Availability_Disc_Agreement
END
GO
CREATE PROCEDURE Usp_Check_Availability_Disc_Agreement
@DISTRIBUTOR_ID VARCHAR(10),
@BRANDPACK_ID VARCHAR(14),
@O_COUNTQTYQ1 BIT OUTPUT,
@O_COUNTQTYQ2 BIT OUTPUT,
@O_COUNTQTYQ3 BIT OUTPUT,
@O_COUNTQTYQ4 BIT OUTPUT,
@O_COUNTQTYS1 BIT OUTPUT,
@O_COUNTQTYS2 BIT OUTPUT,
@O_COUNTQTYY BIT OUTPUT,
@O_DEVIDED_QTY DECIMAL(18,3) OUTPUT,
@O_DEVIDE_FACTOR DECIMAL(18,3) OUTPUT,
@O_UNIT VARCHAR(15) OUTPUT,
@PO_DATE SMALLDATETIME
AS
SET NOCOUNT ON;

DECLARE @IsInvoice BIT, @IA_BRANDPACK_ID VARCHAR(14), @V_BRANDPACK_NAME VARCHAR(100),@V_BRANDPACK_ID VARCHAR(14);
SELECT @IsInvoice = (SELECT AllowRules FROM RefBussinesRules WHERE CodeApp = 'MSC0007');
SELECT @O_DEVIDED_QTY = (SELECT DEVIDED_QUANTITY FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );
SELECT @O_DEVIDE_FACTOR = (SELECT TOP 1 DEVIDE_FACTOR FROM BRND_PACK WHERE PACK_ID = (SELECT TOP 1 PACK_ID FROM BRND_BRANDPACK 
							WHERE BRANDPACK_ID = @BRANDPACK_ID));
SELECT @O_UNIT = (SELECT UNIT FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );
IF (@IsInvoice = 1)
BEGIN
	

	IF OBJECT_ID('tempdb..#T_SAVING') IS NOT NULL
    BEGIN DROP TABLE #T_SAVING; END

	SELECT ACRH.FLAG,ACRD.DISC_QTY,ACRD.LEFT_QTY INTO #T_SAVING FROM ACCRUED_HEADER ACRH INNER JOIN ACCRUED_DETAIL ACRD ON ACRH.ACHIEVEMENT_ID
        = ACRD.ACHIEVEMENT_ID WHERE ACRD.CAN_RELEASE = 1 AND ACRH.AGREEMENT_NO = ANY(SELECT AGREEMENT_NO FROM AGREE_AGREEMENT
        WHERE YEAR(END_DATE) >= YEAR(@PO_DATE) -2 )AND ACRH.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ACRD.BRANDPACK_ID = @BRANDPACK_ID;  
        
    CREATE CLUSTERED INDEX IDX_T_S ON #T_SAVING(FLAG,LEFT_QTY);
	SELECT @O_COUNTQTYQ1 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q1' AND LEFT_QTY > 0)),0);
	
	SELECT @O_COUNTQTYQ2 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q2' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYQ3 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q3' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYQ4 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q4' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYS1 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'S1' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYS2 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'S2' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYY = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Y' AND LEFT_QTY > 0)),0);
	DROP TABLE #T_SAVING;
END
ELSE
BEGIN
RAISERROR('DPD is not set to Invoice',16,1);
END
GO
-------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Availability_Disc_Sales' AND TYPE = 'P')
BEGIN
DROP PROCEDURE Usp_Check_Availability_Disc_Sales ;
END
GO
CREATE PROCEDURE Usp_Check_Availability_Disc_Sales
@DISTRIBUTOR_ID VARCHAR(10),
@BRANDPACK_ID VARCHAR(14),
@O_DEVIDED_QTY DECIMAL(18,3) OUTPUT,
@O_DEVIDE_FACTOR DECIMAL(18,3) OUTPUT,
@PO_DATE SMALLDATETIME,
@O_UNIT VARCHAR(15) OUTPUT,
@O_COUNTMG BIT OUTPUT,
@O_COUNTCPR BIT OUTPUT,
@O_COUNTCPD BIT OUTPUT,
@O_COUNTCPSD BIT OUTPUT,
@O_COUNTKP BIT OUTPUT,
@O_COUNTDK BIT OUTPUT,
@O_CountCPSD_TM BIT OUTPUT,
@O_CountCPD_TM BIT OUTPUT,
@O_CountCPMRT_TM BIT OUTPUT,
@O_CountCPMRT_D BIT OUTPUT
AS 
SET NOCOUNT ON;
SELECT @O_DEVIDED_QTY = (SELECT DEVIDED_QUANTITY FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );
SELECT @O_DEVIDE_FACTOR = (SELECT TOP 1 DEVIDE_FACTOR FROM BRND_PACK WHERE PACK_ID = (SELECT TOP 1 PACK_ID FROM BRND_BRANDPACK 
						   WHERE BRANDPACK_ID = @BRANDPACK_ID));
SELECT @O_UNIT = (SELECT UNIT FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );

IF OBJECT_ID('tempdb..#T_MRKT') IS NOT NULL
BEGIN DROP TABLE #T_MRKT; END

SELECT MBD.ISRPK,MBD.GIVEN_DISC_PCT,MBD.ISPKPP,MBD.ISDK,MBD.ISCPR,MBD.ISCP,MBD.ISSCPD,MBD.ISCPMRT,MBD.IS_T_TM_DIST,MBD.ISHK INTO #T_MRKT
FROM MRKT_BRANDPACK_DISTRIBUTOR MBD INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
WHERE MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND MBD.BONUS_VALUE = 0
AND MB.BRANDPACK_ID = @BRANDPACK_ID;

SELECT @O_COUNTMG = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISRPK,GIVEN_DISC_PCT FROM #T_MRKT WHERE (ISPKPP = 0
                    AND ISDK = 0 AND ISCPR = 0 AND ISCP = 0 AND ISHK = 0))),0) OPTION(KEEP PLAN);
SELECT @O_COUNTCPR = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISCPR FROM #T_MRKT WHERE ISCPR = 1)),0);

SELECT @O_COUNTKP = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISPKPP FROM #T_MRKT WHERE ISPKPP = 1)),0);
SELECT @O_COUNTDK = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISDK  FROM #T_MRKT WHERE ISDK = 1)),0);
--CPD & CPDS DISTRIBUTOR
SELECT @O_COUNTCPD = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISCP FROM #T_MRKT WHERE (ISCP = 1 AND ISSCPD = 0 AND IS_T_TM_DIST = 0))),0);
SELECT @O_COUNTCPSD = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISSCPD  FROM #T_MRKT WHERE (ISCP = 1 AND ISSCPD = 1 AND IS_T_TM_DIST = 0))),0);
--CPD & CPDS TM_DISTRIBUTOR
SELECT @O_CountCPSD_TM = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISSCPD  FROM #T_MRKT WHERE (ISCP = 1 AND ISSCPD = 1 AND IS_T_TM_DIST = 1))),0);
SELECT @O_CountCPD_TM  = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISSCPD  FROM #T_MRKT WHERE (ISCP = 1 AND ISSCPD = 0 AND IS_T_TM_DIST = 1))),0);

SELECT @O_CountCPMRT_TM = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISCPMRT  FROM #T_MRKT WHERE (ISCPMRT = 1 AND IS_T_TM_DIST = 1))),0);

SELECT @O_CountCPMRT_D  = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISCPMRT FROM #T_MRKT WHERE (ISCPMRT = 1 AND IS_T_TM_DIST = 0))),0);
DROP TABLE #T_MRKT;
GO

--------------------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM DBO.SYSOBJECTS WHERE NAME = 'Usp_Check_Availability_Disc_Qty_Sales_Agreement'
	AND TYPE = 'P')
DROP PROCEDURE Usp_Check_Availability_Disc_Qty_Sales_Agreement
GO

CREATE PROCEDURE Usp_Check_Availability_Disc_Qty_Sales_Agreement
@DISTRIBUTOR_ID VARCHAR(10),
@BRANDPACK_ID VARCHAR(14),
@DISC_AGREE_FROM VARCHAR(20),
@PO_DATE DATETIME,
@O_COUNTQTYQ1 INT OUTPUT,
@O_COUNTQTYQ2 INT OUTPUT,
@O_COUNTQTYQ3 INT OUTPUT,
@O_COUNTQTYQ4 INT OUTPUT,
@O_COUNTQTYS1 INT OUTPUT,
@O_COUNTQTYS2 INT OUTPUT,
@O_COUNTQTYY INT OUTPUT,
@O_COUNTMG INT OUTPUT,
@O_COUNTCPR INT OUTPUT,
@O_COUNTCPD INT OUTPUT,
@O_COUNTCPSD INT OUTPUT,
@O_COUNTKP INT OUTPUT,
@O_COUNTDK INT OUTPUT,
@O_COUNLEFQTYMS INT OUTPUT,
@O_COUNTLEFTQTYMT INT OUTPUT,
@O_COUNTPROJECT INT OUTPUT,
@O_DEVIDED_QTY DECIMAL(18,3) OUTPUT,
@O_DEVIDE_FACTOR DECIMAL(18,3) OUTPUT,
@O_UNIT VARCHAR(15) OUTPUT
AS
SET NOCOUNT ON;
DECLARE @IA_BRANDPACK_ID VARCHAR(14), @V_BRANDPACK_NAME VARCHAR(100),@V_BRANDPACK_ID VARCHAR(14);

SELECT @O_DEVIDED_QTY = (SELECT DEVIDED_QUANTITY FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );
SELECT @O_DEVIDE_FACTOR = (SELECT DEVIDE_FACTOR FROM BRND_PACK WHERE PACK_ID = (SELECT PACK_ID FROM BRND_BRANDPACK 
			WHERE BRANDPACK_ID = @BRANDPACK_ID));
SELECT @O_UNIT = (SELECT UNIT FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID );
IF(@DISC_AGREE_FROM = 'INVOICE')
     BEGIN
	IF OBJECT_ID('tempdb..#T_SAVING') IS NOT NULL
           BEGIN DROP TABLE #T_SAVING; END
	SELECT ACRH.FLAG,ACRD.DISC_QTY,ACRD.LEFT_QTY INTO #T_SAVING FROM ACCRUED_HEADER ACRH INNER JOIN ACCRUED_DETAIL ACRD ON ACRH.ACHIEVEMENT_ID
        = ACRD.ACHIEVEMENT_ID WHERE ACRD.CAN_RELEASE = 1 AND ACRH.AGREEMENT_NO = ANY(SELECT AGREEMENT_NO FROM AGREE_AGREEMENT
        WHERE YEAR(END_DATE) >= YEAR(@PO_DATE) -2 )AND ACRH.DISTRIBUTOR_ID = @DISTRIBUTOR_ID AND ACRD.BRANDPACK_ID = @BRANDPACK_ID;  
        
        CREATE CLUSTERED INDEX IDX_T_S ON #T_SAVING(FLAG,LEFT_QTY);
	SELECT @O_COUNTQTYQ1 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q1' AND LEFT_QTY > 0)),0);
	
	SELECT @O_COUNTQTYQ2 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q2' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYQ3 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q3' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYQ4 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Q4' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYS1 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'S1' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYS2 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'S2' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYY = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING WHERE FLAG = 'Y' AND LEFT_QTY > 0)),0);
	DROP TABLE #T_SAVING;
     END
ELSE
     BEGIN
	SET @V_BRANDPACK_NAME = (SELECT BRANDPACK_NAME FROM BRND_BRANDPACK WHERE BRANDPACK_ID = @BRANDPACK_ID);
        SELECT @IA_BRANDPACK_ID = CASE @V_BRANDPACK_NAME
         WHEN 'GIBGRO 10 SP SACHET 1 KG  @ 1 GR- D' THEN '00898001KD'
         WHEN 'GIBGRO 20% TABLET @ 5 GR - D' THEN '00896005GD'
         ELSE (SELECT TOP 1 BRANDPACK_ID FROM BRND_BRANDPACK WHERE BRANDPACK_NAME = @V_BRANDPACK_NAME 
           AND ((IsActive = 1 AND IsObsolete = 1) OR BRANDPACK_ID <> @BRANDPACK_ID))
         END
     	IF(@IA_BRANDPACK_ID IS NOT NULL)
   	BEGIN SET @V_BRANDPACK_ID = @IA_BRANDPACK_ID; END
   	ELSE BEGIN SET @V_BRANDPACK_ID = @BRANDPACK_ID ; END
	IF OBJECT_ID('tempdb..#T_SAVING1') IS NOT NULL
           BEGIN DROP TABLE #T_SAVING1; END
	SELECT BBS.LEFT_QTY,BBS.QSY_FLAG AS FLAG INTO #T_SAVING1 
	FROM BRND_BRANDPACK_SAVING BBS INNER JOIN AGREE_BRANDPACK_INCLUDE ABI 
	ON BBS.AGREE_BRANDPACK_ID = ABI.AGREE_BRANDPACK_ID INNER JOIN AGREE_AGREEMENT AA ON AA.AGREEMENT_NO
	= ABI.AGREEMENT_NO WHERE BBS.DISTRIBUTOR_ID = @DISTRIBUTOR_ID  
	AND YEAR(AA.END_DATE) >= YEAR(@PO_DATE) - 1 AND BBS.LEFT_QTY > 0 AND ABI.BRANDPACK_ID = @V_BRANDPACK_ID;

        CREATE CLUSTERED INDEX IDX_T_S1 ON #T_SAVING1(FLAG,LEFT_QTY);
    
	SELECT @O_COUNTQTYQ1 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'Q1' AND LEFT_QTY > 0)),0);
	
	SELECT @O_COUNTQTYQ2 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'Q2' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYQ3 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'Q3' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYQ4 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'Q4' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYS1 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'S1' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYS2 = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'S2' AND LEFT_QTY > 0)),0);

	SELECT @O_COUNTQTYY = ISNULL((SELECT 1 WHERE EXISTS(SELECT LEFT_QTY FROM #T_SAVING1 WHERE FLAG = 'Y' AND LEFT_QTY > 0)),0);
	DROP TABLE #T_SAVING1;
	
     END
IF OBJECT_ID('tempdb..#T_MRKT') IS NOT NULL
           BEGIN DROP TABLE #T_MRKT; END
SELECT MBD.ISRPK,MBD.GIVEN_DISC_PCT,MBD.ISPKPP,MBD.ISDK,MBD.ISCPR,MBD.ISCP,MBD.ISSCPD,MBD.ISHK INTO #T_MRKT
FROM MRKT_BRANDPACK_DISTRIBUTOR MBD INNER JOIN MRKT_BRANDPACK MB ON MBD.PROG_BRANDPACK_ID = MB.PROG_BRANDPACK_ID
WHERE MBD.START_DATE <= @PO_DATE AND MBD.END_DATE >= @PO_DATE AND MBD.DISTRIBUTOR_ID = @DISTRIBUTOR_ID
AND MBD.BONUS_VALUE = 0
AND MB.BRANDPACK_ID = @BRANDPACK_ID;

SELECT @O_COUNTMG = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISRPK,GIVEN_DISC_PCT FROM #T_MRKT WHERE (ISPKPP = 0
                    AND ISDK = 0 AND ISCPR = 0 AND ISCP = 0 AND ISHK = 0))),0) OPTION(KEEP PLAN);
SELECT @O_COUNTCPR = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISCPR FROM #T_MRKT WHERE ISCPR = 1)),0);
SELECT @O_COUNTCPD = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISCP FROM #T_MRKT WHERE ISCP = 1 AND (ISSCPD = 0 OR ISSCPD IS NULL))),0);
SELECT @O_COUNTKP = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISPKPP FROM #T_MRKT WHERE ISPKPP = 1)),0);
SELECT @O_COUNTDK = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISDK  FROM #T_MRKT WHERE ISDK = 1)),0);
SELECT @O_COUNTCPSD = ISNULL((SELECT 1 WHERE EXISTS(SELECT TOP 1 ISSCPD  FROM #T_MRKT WHERE (ISCP = 1 AND ISSCPD = 1))),0);
DROP TABLE #T_MRKT;
GO
----------------------------------------------------------------------------------------
--SELECT * FROM MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = '0362/NI/II/201277290250MDPAN112IDR'
--SELECT * FROM MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_DIST_ID = '0364/NI/II/201277290250MDPAN112IDR'
--
--SELECT * FROM MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_ID = ANY(
--SELECT PROG_BRANDPACK_ID FROM MRKT_BRANDPACK WHERE PROGRAM_ID = '0535/NI/III/12')
--
--PROGRAM ID : 0364/NI/II/2012
--
--PERIODE PROGRAM 
--STARTDATE : 2012-02-28 
--END DATE  : 2012-03-21
--TOTAL_QTY = 150.000
--
--
--SELECT * FROM MRKT_BRANDPACK_DISTRIBUTOR WHERE PROG_BRANDPACK_ID = ANY(
--SELECT PROG_BRANDPACK_ID FROM MRKT_BRANDPACK WHERE PROGRAM_ID = '0535/NI/III/12')
--
--PROGRAM_ID : 0535/NI/III/12
--
--PERIODE PROGRAM START DATE :2012-03-12
--END DATE 		   :2012-05-31
--TOTAL_QTY : 150.000
--
--
--
--exec Usp_Generate_Sales_Discount_Stage_1 @DISTRIBUTOR_ID = 'PAN112IDR', @BRANDPACK_ID = '77290250MD', @PO_REF_NO = 'POJBR/0312/0083', @FLAG = 'CS'
--GO
--declare @P1 numeric(29,3)
--set @P1=280.000
--declare @P2 numeric(29,3)
--set @P2=150.000
--exec Usp_Get_SUM_PO_QTY_BY_TARGET_SALES @FLAG = 'CS', @PROG_BRANDPACK_DIST_ID = '0362/NI/II/201277290250MDPAN112IDR', @DISTRIBUTOR_ID = 'PAN112IDR', @BRANDPACK_ID = '77290250MD', 
--@PO_REF_NO = 'POJBR/0312/0083', @O_TARGET_QTY = @P1 output, @O_SUMPO_QTY = @P2 output
--select TARGET_QTY = @P1 , SUM_PO_QTY = @P2  
--go
--
--declare @P1 numeric(29,3)
--set @P1=180.000
--declare @P2 numeric(29,3)
--set @P2=150.000
--exec Usp_Get_SUM_PO_QTY_BY_TARGET_SALES @FLAG = 'CS', @PROG_BRANDPACK_DIST_ID = '0535/NI/III/1277290250MDPAN112IDR', @DISTRIBUTOR_ID = 'PAN112IDR', @BRANDPACK_ID = '77290250MD', 
--@PO_REF_NO = 'POJBR/0312/0083', @O_TARGET_QTY = @P1 output, @O_SUMPO_QTY = @P2 output
--select TARGET_QTY = @P1 , SUM_PO_QTY = @P2  
--go
--
--
--
--exec Usp_Generate_Sales_Discount_Stage_1 @DISTRIBUTOR_ID = 'IND004IDR', @BRANDPACK_ID = '00010400MD', @PO_REF_NO = '0217/PO/INP/III/12', @FLAG = 'CP'
--
--declare @P1 numeric(29,3)
--set @P1=2500.000
--declare @P2 numeric(29,3)
--set @P2=1248.000
--exec Usp_Get_SUM_PO_QTY_BY_TARGET_SALES @FLAG = 'CP', @PROG_BRANDPACK_DIST_ID = '0572/NI/III/1200010400MDIND004IDR', @DISTRIBUTOR_ID = 'IND004IDR', @BRANDPACK_ID = '00010400MD', 
--@PO_REF_NO = '0217/PO/INP/III/12', @O_TARGET_QTY = @P1 output, @O_SUMPO_QTY = @P2 output
--select TARGET_QTY = @P1 , SUM_PO_QTY = @P2  